<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Clinic SOAP Generator</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      line-height: 1.5;
      background: #000;
      color: #f5f5f5;
    }
    label { display: block; margin-top: 8px; }
    .section {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #111;
      border: 1px solid #333;
    }
    textarea {
      width: 100%;
      height: 260px;
      background: #111;
      color: #f5f5f5;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px;
      white-space: pre-wrap;
    }

/* 讓 Output / Doctor note 並排 */
.section-row {
  display: flex;
  gap: 16px;
  align-items: stretch;
}

/* 每一欄平均分配寬度 */
.section-row .section {
  flex: 1;
}

/* 手機螢幕自動變成上下排列 */
@media (max-width: 900px) {
  .section-row {
    flex-direction: column;
  }
}
    select, input {
      padding: 4px;
      margin-top: 4px;
      background: #111;
      color: #f5f5f5;
      border: 1px solid #555;
      border-radius: 4px;
    }
button {
  padding: 8px 14px;
  margin-top: 10px;
  margin-right: 6px;
  cursor: pointer;
  border-radius: 4px;
  border: 1px solid #888;
  background: #222;
  color: #f5f5f5;
}

button:hover {
  background: #333;
}

/* === 新增：性別按鈕 === */
.sex-btn {
  margin-left: 6px;
}

.sex-btn.active {
  background: #555;
  border-color: #fff;
}
    h2 { margin-bottom: 16px; }
    #qrcode {
      margin-top: 8px;
    }
    pre {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      word-wrap: break-word; /* 讓長字串強制換行 */
      overflow-wrap: anywhere; /* 任何地方都能斷行，避免截斷 */
    }
  </style>
  <!-- 用來產生 QR code 的小工具（前端用，安全） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body>

<h2>Clinic SOAP Generator</h2>

<!-- Patient Info -->
<div class="section">
  <strong>Patient Info</strong><br>
  Age: <input id="age" type="number" min="0" max="120" style="width: 60px;">
Sex:
<button type="button" class="sex-btn" data-value="M">Male</button>
<button type="button" class="sex-btn" data-value="F">Female</button>
<input type="hidden" id="sex">
</div>

<!-- Chief complaint -->
<div class="section">
  <label>Chief complaint:</label>
  <select id="ccSelect">
    <option value="">Select</option>

    <optgroup label="General">
      <option value="fever">Fever / URI</option>
      <option value="fatigue">Fatigue</option>
      <option value="weight_loss">Body weight loss / Unintentional weight loss</option>
      <option value="fuo">Fever of unclear source</option>
    </optgroup>

    <optgroup label="Cardiovascular / Respiratory">
      <option value="chest_pain">Chest pain</option>
      <option value="palpitations">Palpitations</option>
      <option value="sob">Shortness of breath / Dyspnea</option>
      <option value="cough">Cough</option>
    </optgroup>

    <optgroup label="Neurologic">
      <option value="headache">Headache</option>
      <option value="dizziness">Dizziness / Vertigo</option>
    </optgroup>

    <optgroup label="Psychiatric">
  <option value="insomnia">Insomnia</option>
  <option value="depression">Depression</option>
  <option value="anxiety">Anxiety</option>
</optgroup>

    <optgroup label="Gastrointestinal">
      <option value="abd_pain">Abdominal pain</option>
      <option value="abd_bloating">Abdominal bloating / Distension</option>
      <option value="diarrhea">Diarrhea</option>
      <option value="constipation">Constipation</option>
    </optgroup>

    <optgroup label="Edema / MSK">
      <option value="edema">Leg swelling / Edema</option>
    </optgroup>

    <optgroup label="Chronic Disease Follow-up">
      <option value="htn_fup">Hypertension follow-up</option>
      <option value="dm_fup">Diabetes follow-up</option>
      <option value="lipid_fup">Hyperlipidemia follow-up</option>
    </optgroup>

    <optgroup label="Health Exam Abnormality">
      <option value="exam_abnormal">Abnormal health exam / lab abnormality</option>
    </optgroup>
  </select>
</div>

<!-- History questions -->
<div class="section">
  <strong>History questions:</strong>
  <div id="historyArea">Select a chief complaint to begin.</div>
</div>

<!-- Past history -->
<div class="section">
  <strong>Past History</strong>

  <label>PH:</label>
  <input id="ph" type="text" placeholder="預設 denied">

  <label>Allergy:</label>
  <input id="allergy" type="text" placeholder="預設 NKA">

  <label>Med:</label>
  <input id="med" type="text" placeholder="預設 denied">

  <label>FH:</label>
  <input id="fh" type="text" placeholder="預設 no contributory">

  <label>Surgery:</label>
  <input id="surg" type="text" placeholder="例如：appendectomy in 2018">

  <label>Social History:</label>
  <input id="sh" type="text" placeholder="預設 denied alcohol, betel or cigarette">
</div>


  
<!-- Buttons -->
<div class="section">
  <button id="generateBtn">Generate SOAP</button>
  <button id="openEvidenceBtn">Open in OpenEvidence</button>
  <button id="chatgptBtn">Open in ChatGPT (PC)</button>
</div>

<div class="section-row">
  <!-- Output -->
  <div class="section">
    <strong>Output:</strong>
    <textarea id="output"></textarea>
      <button id="askAiBtn">Plan</button>
    <button id="chronicPlanBtn">主治慢性病追蹤</button>

  </div>

  <!-- Doctor note -->
  <div class="section">
    <strong>Free note</strong>
    <textarea id="freeAiInput"
      placeholder="在這裡貼上：上一份病歷、這次回診抽血結果或最新病況摘要…"></textarea>
    <button id="freeAiBtn">Next step</button>
    <button id="hxSuggestBtn">問診建議</button>
  </div>
</div>


<!-- AI suggestion + Free typing panel -->
<div class="section-row">
  
  <!-- 左側：AI 建議 -->
  <div class="section" style="flex: 2;">
    <strong>Additional considerations:</strong>
    <div id="aiStatus" style="font-size:0.9em;color:#aaa;margin-top:4px;"></div>
    <pre id="aiResult" style="margin-top:6px;"></pre>
  </div>

  <!-- 右側：新的自由打字區域 -->
  <div class="section" style="flex: 1;">
    <strong>Quick note</strong>
    <textarea
      id="sideNote"
      placeholder="可在此自由打字：邊看 AI 建議邊問診/做筆記，不會覆蓋掉內容。"
      style="height: 800px; width: 100%; background:#111; color:#f5f5f5; border:1px solid #555; border-radius:4px; padding:8px;"
    ></textarea>
  </div>

</div>

<script>
// ========================== Templates ==========================
const templates = {
  // ---- 原本：sore throat / fever / abd pain ----
  sore_throat: {
    nameEn: "sore throat",
    history: [
      { id:"duration",   labelEn:"Duration",                            labelZh:"症狀多久？（天）" },
      { id:"fever",      labelEn:"fever up to",                         labelZh:"發燒？最高幾度？" },
      { id:"rhinorrhea", labelEn:"rhinorrhea",                          labelZh:"流鼻水？鼻塞？" },
      { id:"odynophagia",labelEn:"odynophagia",                         labelZh:"吞嚥痛？" },
      { id:"cough",      labelEn:"cough",                               labelZh:"咳嗽？" },
      { id:"tocc",       labelEn:"TOCC",                                labelZh:"接觸史 / 感染接觸者？" }
    ],
    ddx: [
      "Viral pharyngitis",
      "Streptococcal pharyngitis",
      "Peritonsillar abscess"
    ]
  },

  fever: {
    nameEn: "fever",
    history: [
      { id:"duration", labelEn:"Duration",               labelZh:"發燒多久？" },
      { id:"max_temp", labelEn:"fever up to",            labelZh:"最高體溫？" },
      { id:"resp",     labelEn:"respiratory symptoms",   labelZh:"呼吸道症狀？" },
      { id:"gi",       labelEn:"GI symptoms",            labelZh:"腸胃症狀？" },
      { id:"urinary",  labelEn:"urinary symptoms",       labelZh:"泌尿症狀？" },
      { id:"travel",   labelEn:"travel / TOCC",          labelZh:"旅遊史/TOCC？" }
    ],
    ddx: [
      "Viral infection",
      "Bacterial infection",
      "UTI",
      "Pneumonia"
    ]
  },

  abd_pain: {
  nameEn: "abdominal pain",
  history: [
    { id:"duration",   labelEn:"Duration",                labelZh:"腹痛多久？" },

    // P – Provocation / Palliation
    { id:"provocation",labelEn:"Provocation/Palliation",  labelZh:"什麼會讓疼痛加劇？（動作/食物等）" },
    { id:"palliation", labelEn:"Palliation",              labelZh:"什麼方法會讓疼痛緩解？（休息/按壓/排便）" },

    // Q – Quality / Quantity
    { id:"quality",    labelEn:"Pain quality",            labelZh:"疼痛性質？（絞痛/刺痛/悶痛/燒灼/脹痛）" },
    { id:"pain_score", labelEn:"Pain score",              labelZh:"疼痛程度 0～10 分？" },

    // R – Region / Radiation
    { id:"location",   labelEn:"Location",                labelZh:"疼痛的位置？" },
    { id:"radiation",  labelEn:"Radiation",               labelZh:"疼痛會放散到哪裡？（背部/肩膀/腹股溝等）" },

    // S – Severity（可留 pain score）
    // （已包含上面 pain_score）

    // T – Timing
    { id:"onset",      labelEn:"Onset/Timing",            labelZh:"何時開始？持續性或間歇性？一天中何時最痛？" },

    // Associated symptoms
    { id:"gi",         labelEn:"GI symptoms",             labelZh:"噁心/嘔吐/腹瀉？" },
    { id:"bleed",      labelEn:"GI bleeding",             labelZh:"黑便/血便？" },
    { id:"urinary",    labelEn:"Urinary symptoms",        labelZh:"泌尿症狀？" },
    { id:"gyne",       labelEn:"Gynecologic history",     labelZh:"月經/懷孕？（女性）" }
  ],

  ddx: [
    "Gastroenteritis",
    "Peptic ulcer disease",
    "Appendicitis",
    "Cholecystitis",
    "Renal colic",
    "Pancreatitis",
    "Ectopic pregnancy (female)"
  ]
},


  // ---- Chest pain（完整版）----
  chest_pain: {
    nameEn: "chest pain",
    history: [
      // Onset & timing
      { id:"onset",      labelZh:"什麼時候開始胸痛？突然還是漸進？", labelEn:"onset & timing" },
      { id:"first_time", labelZh:"第一次發作？以前也有類似胸痛？",   labelEn:"first episode or recurrent" },
      { id:"pattern",    labelZh:"持續痛還是間歇性？",               labelEn:"constant or intermittent" },

      // Location
      { id:"location",   labelZh:"疼痛位置（胸口中央／左邊／右邊）？", labelEn:"location" },
      { id:"depth",      labelZh:"感覺是表層還是深層？",               labelEn:"superficial or deep" },

      // Quality & severity
      { id:"quality",    labelZh:"疼痛性質（壓迫、緊縮、刺痛、灼熱、撕裂感…）", labelEn:"quality" },
      { id:"severity",   labelZh:"0–10 分現在幾分？",                         labelEn:"severity (0-10)" },

      // Radiation
      { id:"radiation",  labelZh:"會不會痛到左手、肩膀、背部或下巴？",   labelEn:"radiation" },

      // Provoking & relieving factors
      { id:"exertion",   labelZh:"活動／走路／爬樓梯會加重？",         labelEn:"worse with exertion" },
      { id:"pleuritic",  labelZh:"深呼吸、咳嗽會更痛？",               labelEn:"worse with deep breath / cough" },
      { id:"rest_relief",labelZh:"休息有沒有比較好？",                 labelEn:"relieved by rest" },
      { id:"meal_relief",labelZh:"和吃東西或吞嚥有關嗎？",             labelEn:"relation to meals / swallowing" },

      // Associated symptoms
      { id:"sob",        labelZh:"有沒有呼吸困難？",                   labelEn:"shortness of breath" },
      { id:"diaphoresis",labelZh:"有沒有冒冷汗？",                     labelEn:"diaphoresis" },
      { id:"nausea",     labelZh:"有沒有噁心或嘔吐？",                 labelEn:"nausea / vomiting" },
      { id:"near_syncope",labelZh:"會不會頭暈或快昏倒？",              labelEn:"dizziness / near-syncope" },
      { id:"cough_hemoptysis",labelZh:"有沒有咳嗽或咳血？",            labelEn:"cough / hemoptysis" },
      { id:"fever",      labelZh:"有沒有發燒？",                       labelEn:"fever" },

      // Cardiac risk factors
      { id:"cv_risk",    labelZh:"是否有高血壓、糖尿病、高血脂、抽菸、早發心臟病家族史？", labelEn:"cardiovascular risk factors" },

      // Thromboembolism risk (PE)
      { id:"pe_risk",    labelZh:"最近有久坐、長途飛行、手術、臥床或下肢腫痛？", labelEn:"PE risk (immobilization, surgery, leg swelling)" },

      // Aortic dissection clues
      { id:"dissection", labelZh:"是否突然像撕裂般劇痛？是否放射到背部？有高血壓病史？", labelEn:"tearing pain / back radiation / HTN" },

      // GI / MSK clues
      { id:"gi",         labelZh:"是否有燒灼感、打嗝、胃酸逆流，飯後或躺下更痛？", labelEn:"GERD-like symptoms" },
      { id:"msk",        labelZh:"按壓胸壁或轉身會不會更痛？",                   labelEn:"reproducible by palpation / movement" },

      // Medication & substances
      { id:"nitro",      labelZh:"有沒有含用硝酸甘油？效果如何？",               labelEn:"response to nitroglycerin" },
      { id:"drugs",      labelZh:"最近有沒有使用可卡因或其他興奮劑？",           labelEn:"cocaine / stimulant use" }
    ],
    ddx: [
      "Acute coronary syndrome (unstable angina / myocardial infarction)",
      "Aortic dissection",
      "Pulmonary embolism",
      "Pericarditis / pneumonia / pleuritis",
      "Gastroesophageal reflux disease",
      "Costochondritis or musculoskeletal chest wall pain"
    ]
  },


  // ---- SOB ----
  sob: {
    nameEn: "shortness of breath",
    history: [
      { id:"duration",   labelEn:"Duration",             labelZh:"喘多久？" },
      { id:"onset",      labelEn:"onset",                labelZh:"起病時間/方式？" },
      { id:"exertional", labelEn:"exertional dyspnea",   labelZh:"勞累時會喘？" },
      { id:"orthopnea",  labelEn:"orthopnea / PND",      labelZh:"平躺喘/夜間陣發性喘？" },
      { id:"cough",      labelEn:"cough/sputum",         labelZh:"咳嗽/痰？" },
      { id:"wheezing",   labelEn:"wheezing",             labelZh:"喘鳴？" },
      { id:"fever",      labelEn:"fever",                labelZh:"發燒？" },
      { id:"leg_swelling",labelEn:"leg swelling",        labelZh:"下肢水腫？" },
      { id:"risk",       labelEn:"smoking / cardiac hx", labelZh:"吸菸/心臟病史？" }
    ],
    ddx: [
      "Heart failure",
      "COPD/asthma exacerbation",
      "Pneumonia",
      "Pulmonary embolism",
      "Anemia"
    ]
  },

// ---- Headache (full structured template) ----
headache: {
  nameEn: "headache",
  history: [
    // Onset & timing
    { id: "onset",          labelEn: "Onset",                     labelZh: "何時開始頭痛？" },
    { id: "sudden",         labelEn: "Sudden or gradual onset",   labelZh: "突然還是慢慢開始？" },
    { id: "first_time",     labelEn: "First episode?",            labelZh: "第一次出現？以前也有？" },
    { id: "pattern",        labelEn: "Pattern (constant/intermittent)", labelZh: "持續或間歇性？" },
    { id: "worst_time",     labelEn: "Worst time of day",         labelZh: "一天中何時最痛？" },

    // Location
    { id: "location",       labelEn: "Location",                  labelZh: "痛在哪裡？單側或雙側？" },

    // Quality & severity
    { id: "quality",        labelEn: "Quality",                   labelZh: "痛的性質？（跳痛、悶痛、壓迫、刺痛…）" },
    { id: "severity",       labelEn: "Severity (0–10)",           labelZh: "嚴重程度 0–10 分？" },

    // Trigger & relief
    { id: "trigger",        labelEn: "Triggers",                  labelZh: "什麼會加重？（光、聲、活動…）" },
    { id: "relief",         labelEn: "Relieving factors",         labelZh: "什麼會緩解？休息？止痛藥？" },

    // Associated symptoms
    { id: "nausea",         labelEn: "Nausea/vomiting",           labelZh: "有噁心或嘔吐？" },
    { id: "photophobia",    labelEn: "Photophobia/phonophobia",   labelZh: "畏光畏聲？" },
    { id: "aura",           labelEn: "Aura/visual disturbance",   labelZh: "閃光、黑點、視力改變？" },
    { id: "fever",          labelEn: "Fever/neck stiffness",      labelZh: "發燒或頸部僵硬？" },
    { id: "neuro",          labelEn: "Neuro deficits",            labelZh: "手腳無力、說話困難？" },

    // Radiation
    { id: "radiation",      labelEn: "Radiation",                 labelZh: "是否放射到脖子、眼睛？" },

    // Past headache history
    { id: "past_hx",        labelEn: "Previous headache history", labelZh: "以前有類似頭痛？診斷？治療效果？" },

    // Triggers (lifestyle)
    { id: "lifestyle",      labelEn: "Triggers (stress/sleep/caffeine/alcohol/menstruation)", 
                             labelZh: "壓力、睡眠、咖啡因、酒精、月經影響？" },

    // Medications
    { id: "meds",           labelEn: "Meds (new meds, analgesic overuse)", 
                             labelZh: "新藥？止痛藥使用頻率？反彈頭痛？" },

    // Systemic diseases / risk factors
    { id: "systemic",       labelEn: "Systemic disease risks",    labelZh: "癌症、免疫低下、懷孕、外傷？" }
  ],
  ddx: [
    "Migraine",
    "Tension-type headache",
    "Cluster headache",
    "SAH (subarachnoid hemorrhage)",
    "Meningitis",
    "Brain tumor / increased ICP",
    "Giant cell arteritis",
    "Medication-overuse headache"
  ]
},


dizziness: {
  nameEn: "dizziness / vertigo",
  history: [
    { id:"type", labelZh:"你說的頭暈是天旋地轉？快要昏倒？還是步態不穩？", labelEn:"type of dizziness" },

    // Onset & timing
    { id:"onset", labelZh:"什麼時候開始？突然還是漸進？", labelEn:"onset" },
    { id:"duration", labelZh:"每次暈多久？（秒／分鐘／小時）", labelEn:"duration of episodes" },
    { id:"pattern", labelZh:"持續性？還是反覆發作？", labelEn:"episodic or continuous" },

    // Trigger
    { id:"position", labelZh:"是否與姿勢／轉頭／起床有關？", labelEn:"position trigger" },

    // Quality – confirm vertigo
    { id:"spinning", labelZh:"是否為旋轉感（天旋地轉）？", labelEn:"spinning sensation" },

    // Severity / functional impact
    { id:"gait", labelZh:"會影響走路或站立嗎？需不需要扶著？", labelEn:"gait instability" },

    // Otologic symptoms
    { id:"hearing", labelZh:"有沒有耳鳴／聽力下降／耳悶？", labelEn:"auditory symptoms" },

    // Neurologic danger signs
    { id:"neuro", labelZh:"是否有無力、麻、複視、吞嚥困難？", labelEn:"neurologic symptoms" },

    // Autonomic
    { id:"nausea", labelZh:"噁心、嘔吐、冒冷汗？", labelEn:"nausea/vomiting" },

    // Cardiovascular / presyncope
    { id:"cardiac", labelZh:"黑矇、心悸、胸悶？站起來會更暈？", labelEn:"presyncope/cardiac symptoms" },

    // Past medical history relevance
    { id:"risk", labelZh:"中風、心臟病、糖尿病、高血壓？", labelEn:"stroke/cardiac risk factors" },
    { id:"uri", labelZh:"最近有感冒／上呼吸道感染？", labelEn:"recent URI" },

    // Medication-related
    { id:"meds", labelZh:"最近有吃新藥？（降壓、鎮靜劑）", labelEn:"medications" }
  ],

  ddx: [
    "Benign paroxysmal positional vertigo (BPPV)",
    "Vestibular neuritis",
    "Ménière disease",
    "Orthostatic hypotension / arrhythmia",
    "Brainstem or cerebellar stroke"
  ]
},

  // ---- Palpitations ----
  palpitations: {
    nameEn: "palpitations",
    history: [
      { id:"duration",   labelEn:"Duration",                 labelZh:"心悸多久？" },
      { id:"onset",      labelEn:"onset/offset",             labelZh:"發作怎麼開始/結束？" },
      { id:"pattern",    labelEn:"pattern",                  labelZh:"規則/不規則？" },
      { id:"triggers",   labelEn:"triggers (exertion/caffeine/ETOH)",labelZh:"誘發因子（運動/咖啡/酒）？" },
      { id:"chest_pain", labelEn:"associated chest discomfort",labelZh:"伴隨胸悶/胸痛？" },
      { id:"dizziness",  labelEn:"dizziness/syncope",        labelZh:"頭暈/暈厥？" },
      { id:"thyroid",    labelEn:"thyroid symptoms",         labelZh:"甲狀腺症狀？" }
    ],
    ddx: [
      "Supraventricular tachycardia",
      "Atrial fibrillation",
      "Premature beats (PAC/PVC)",
      "Hyperthyroidism",
      "Anxiety/panic"
    ]
  },

  // ---- Cough ----
  cough: {
    nameEn: "cough",
    history: [
      { id:"duration",   labelEn:"Duration",          labelZh:"咳嗽多久？" },
      { id:"productive", labelEn:"productive or dry", labelZh:"有痰/乾咳？" },
      { id:"color",      labelEn:"sputum color",      labelZh:"痰顏色？" },
      { id:"fever",      labelEn:"fever",             labelZh:"發燒？" },
      { id:"wheezing",   labelEn:"wheezing",          labelZh:"喘鳴？" },
      { id:"gerd",       labelEn:"GERD symptoms",     labelZh:"火燒心/逆流？" },
      { id:"acei",       labelEn:"ACEi use",          labelZh:"有用ACEI？" },
      { id:"smoking",    labelEn:"smoking history",   labelZh:"抽菸？" }
    ],
    ddx: [
      "Viral upper respiratory infection",
      "Acute bronchitis",
      "Asthma/COPD",
      "Pneumonia",
      "GERD-related cough",
      "ACE inhibitor–induced cough"
    ]
  },

  // ---- Abdominal bloating / distension ----
  abd_bloating: {
    nameEn: "abdominal bloating",
    history: [
      { id:"duration",   labelEn:"Duration",             labelZh:"脹氣/腹脹多久？" },
      { id:"pain",       labelEn:"abdominal pain",       labelZh:"有腹痛嗎？" },
      { id:"bowel",      labelEn:"bowel habit change",   labelZh:"排便習慣改變？" },
      { id:"nausea",     labelEn:"nausea/vomiting",      labelZh:"噁心/嘔吐？" },
      { id:"weight",     labelEn:"weight loss",          labelZh:"體重減輕？" },
      { id:"ascites_risk",labelEn:"liver disease/alcohol",labelZh:"肝病/酗酒？" }
    ],
    ddx: [
      "Functional bloating / IBS",
      "Constipation",
      "Ascites from liver disease",
      "Small bowel obstruction",
      "Ovarian or abdominal mass"
    ]
  },

  // ---- Diarrhea ----
  diarrhea: {
    nameEn: "diarrhea",
    history: [
      { id:"duration",   labelEn:"Duration",          labelZh:"腹瀉多久？" },
      { id:"frequency",  labelEn:"stool frequency",   labelZh:"一天幾次？" },
      { id:"watery",     labelEn:"watery vs bloody",  labelZh:"水瀉還是血便？" },
      { id:"fever",      labelEn:"fever",             labelZh:"發燒？" },
      { id:"abd_pain",   labelEn:"abdominal pain",    labelZh:"腹痛？" },
      { id:"dehydrate",  labelEn:"dehydration signs", labelZh:"口渴/尿量減少？" },
      { id:"travel",     labelEn:"travel / food history",labelZh:"旅遊史/可疑飲食？" },
      { id:"abx",        labelEn:"recent antibiotics",labelZh:"近期用抗生素？" }
    ],
    ddx: [
      "Viral gastroenteritis",
      "Bacterial enteritis / food poisoning",
      "Clostridioides difficile infection",
      "Inflammatory bowel disease",
      "Irritable bowel syndrome"
    ]
  },

  // ---- Constipation ----
  constipation: {
    nameEn: "constipation",
    history: [
      { id:"duration",   labelEn:"Duration",            labelZh:"便祕多久？" },
      { id:"frequency",  labelEn:"stool frequency",     labelZh:"一週排便幾次？" },
      { id:"hard",       labelEn:"hard stool",          labelZh:"乾硬糞便？" },
      { id:"strain",     labelEn:"straining",           labelZh:"用力解便？" },
      { id:"blood",      labelEn:"blood on stool",      labelZh:"便中血？" },
      { id:"meds",       labelEn:"constipating meds",   labelZh:"有無便祕相關藥物（opioid等）？" },
      { id:"thyroid",    labelEn:"hypothyroid symptoms",labelZh:"怕冷、體重增加？" }
    ],
    ddx: [
      "Functional constipation",
      "Irritable bowel syndrome with constipation",
      "Medication-induced constipation",
      "Hypothyroidism",
      "Colorectal malignancy (if alarm features)"
    ]
  },

  // ---- Edema ----
  edema: {
    nameEn: "leg swelling",
    history: [
      { id:"duration",   labelEn:"Duration",           labelZh:"水腫多久？" },
      { id:"laterality", labelEn:"unilateral/bilateral",labelZh:"單側還是雙側？" },
      { id:"pain",       labelEn:"pain/tenderness",    labelZh:"小腿疼痛？" },
      { id:"sob",        labelEn:"associated SOB",     labelZh:"伴隨喘？" },
      { id:"nocturia",   labelEn:"nocturia",           labelZh:"夜尿？" },
      { id:"hx",         labelEn:"cardiac/renal/liver history",labelZh:"心臟/腎臟/肝病史？" },
      { id:"travel",     labelEn:"recent immobilization/travel",labelZh:"久坐/長途旅行？" }
    ],
    ddx: [
      "Heart failure",
      "Deep vein thrombosis",
      "Chronic venous insufficiency",
      "Nephrotic syndrome",
      "Cirrhosis with ascites"
    ]
  },

  // ---- Fatigue ----
  fatigue: {
    nameEn: "fatigue",
    history: [
      { id:"duration",   labelEn:"Duration",               labelZh:"疲倦多久？" },
      { id:"sleep",      labelEn:"sleep quality",          labelZh:"睡眠品質？" },
      { id:"snore",      labelEn:"snoring/apnea",          labelZh:"打呼/睡眠呼吸中止？" },
      { id:"mood",       labelEn:"mood / anhedonia",       labelZh:"心情低落/失去興趣？" },
      { id:"anemia",     labelEn:"anemia symptoms",        labelZh:"頭暈/心悸/蒼白？" },
      { id:"thyroid",    labelEn:"thyroid symptoms",       labelZh:"怕冷/體重變化？" },
      { id:"chronic_dz", labelEn:"chronic medical illness",labelZh:"慢性疾病？" }
    ],
    ddx: [
      "Anemia",
      "Hypothyroidism",
      "Depression",
      "Sleep apnea",
      "Chronic systemic illness"
    ]
  },

  // ---- Body weight loss ----
  weight_loss: {
    nameEn: "body weight loss",
    history: [
      // Amount & time course
      { id: "duration",      labelEn: "Duration",                    labelZh: "體重減輕多久？" },
      { id: "amount",        labelEn: "Amount",                      labelZh: "大約瘦了多少？（幾公斤或百分比）" },
      { id: "intentional",   labelEn: "Intentional?",                labelZh: "是刻意減重，還是非刻意？" },

      // Appetite & intake
      { id: "appetite",      labelEn: "Appetite",                    labelZh: "最近食慾如何？有沒有變差？" },
      { id: "intake",        labelEn: "Dietary intake",              labelZh: "吃的量有比以前少嗎？" },
      { id: "early_satiety", labelEn: "Early satiety",               labelZh: "會不會一吃就飽？（早期飽足感）" },

      // Constitutional symptoms (B symptoms)
      { id: "b_symptoms",    labelEn: "Fever / night sweats",        labelZh: "有沒有發燒、夜間盜汗、明顯疲倦？" },
      { id: "fatigue",       labelEn: "Fatigue",                     labelZh: "容易疲倦、虛弱嗎？" },

      // GI symptoms
      { id: "dysphagia",     labelEn: "Dysphagia",                   labelZh: "有沒有吞嚥困難？" },
      { id: "gi",            labelEn: "GI symptoms",                 labelZh: "噁心、嘔吐、腹痛、腹瀉？" },
      { id: "bowel_change",  labelEn: "Change of bowel habit",       labelZh: "排便習慣有改變嗎？" },
      { id: "gi_bleed",      labelEn: "GI bleeding",                 labelZh: "有沒有黑便或血便？" },

      // Endocrine
      { id: "hyperthyroid",  labelEn: "Hyperthyroid symptoms",       labelZh: "怕熱、心悸、手抖？" },
      { id: "dm",            labelEn: "DM triad",                    labelZh: "口渴、多尿、多食？" },

      // Psych / eating behavior
      { id: "mood",          labelEn: "Mood / depression",           labelZh: "最近心情、壓力如何？憂鬱？" },
      { id: "eating_dis",    labelEn: "Eating disorder behavior",    labelZh: "有沒有刻意節食、暴食或催吐？" },

      // Medication & substances
      { id: "meds",          labelEn: "New medications",             labelZh: "最近有沒有換新藥或開始新藥？" },
      { id: "substance",     labelEn: "Substance use",               labelZh: "抽菸、喝酒或其他藥物使用？" },

      // Malignancy / infection
      { id: "resp",          labelEn: "Resp symptoms",               labelZh: "有沒有慢性咳嗽、咳血、聲音沙啞？" },
      { id: "tb_contact",    labelEn: "TB contact",                  labelZh: "是否有結核病接觸史？" },
      { id: "lump",          labelEn: "Lumps / lymphadenopathy",     labelZh: "有沒有不明腫塊或淋巴結腫大？" },

      // Function
      { id: "function",      labelEn: "Functional status",           labelZh: "體力、日常活動能力有沒有明顯下降？" }
    ],
    ddx: [
      "Malignancy (GI, lung, hematologic, others)",
      "Hyperthyroidism",
      "Diabetes mellitus",
      "Chronic infection (e.g., tuberculosis)",
      "Major depressive disorder",
      "Chronic GI disease or malabsorption",
      "Medication or substance-related weight loss"
    ]
  },

  // ---- FUO / unclear fever ----
  fuo: {
    nameEn: "fever of unclear source",
    history: [
      { id:"duration",   labelEn:"Duration",              labelZh:"發燒多久？" },
      { id:"pattern",    labelEn:"fever pattern",         labelZh:"發燒型態？（持續/間歇）" },
      { id:"localizing", labelEn:"localizing symptoms",   labelZh:"局部症狀？（咳嗽/腹痛/尿痛等）" },
      { id:"weight",     labelEn:"weight loss/night sweats",labelZh:"體重減輕/盜汗？" },
      { id:"travel",     labelEn:"travel / exposure",     labelZh:"旅遊史/動物/環境暴露？" },
      { id:"immune",     labelEn:"immunocompromised",     labelZh:"免疫不全/用類固醇？" }
    ],
    ddx: [
      "Common localized infections (respiratory, urinary, GI, soft tissue)",
      "Viral infections",
      "Inflammatory/autoimmune diseases",
      "Malignancy",
      "Drug fever"
    ]
  },

  // ---- Chronic disease follow-up ----
  htn_fup: {
    nameEn: "hypertension follow-up",
    history: [
      { id:"duration",  labelEn:"Duration since diagnosis", labelZh:"高血壓診斷多久？" },
      { id:"home_bp",   labelEn:"Home BP",                  labelZh:"居家血壓大約多少？" },
      { id:"meds_now",  labelEn:"Current meds",             labelZh:"目前使用哪些降壓藥？" },
      { id:"adherence", labelEn:"Adherence",                labelZh:"服藥規律嗎？會不會忘記吃？" },
      { id:"symptoms",  labelEn:"Symptoms",                 labelZh:"有無頭暈、胸悶、視力模糊等症狀？" }
    ],
    ddx: [
      "Well-controlled essential hypertension",
      "Uncontrolled hypertension",
      "Drug-related hypotension or dizziness",
      "Secondary hypertension"
    ]
  },

  dm_fup: {
    nameEn: "diabetes follow-up",
    history: [
      { id:"duration",  labelEn:"Duration since diagnosis", labelZh:"糖尿病診斷多久？" },
      { id:"home_glu",  labelEn:"Home glucose",             labelZh:"居家血糖大約多少？" },
      { id:"a1c",       labelEn:"Last HbA1c",               labelZh:"最近一次 HbA1c？" },
      { id:"meds_now",  labelEn:"Current meds",             labelZh:"目前使用哪些降糖藥/胰島素？" },
      { id:"adherence", labelEn:"Adherence",                labelZh:"服藥/打針是否規律？" },
      { id:"symptoms",  labelEn:"Symptoms",                 labelZh:"有無多尿、多飲、體重變化、視力模糊、麻木？" }
    ],
    ddx: [
      "Well-controlled type 2 diabetes",
      "Suboptimally controlled diabetes",
      "Hypoglycemia risk",
      "Diabetic complications (neuropathy, nephropathy, retinopathy)"
    ]
  },

  lipid_fup: {
    nameEn: "hyperlipidemia follow-up",
    history: [
  // ===== HLP follow-up (minimal) =====
  { id:"lipid_val",  labelEn:"Recent lipid profile", labelZh:"最近血脂數值（TC/LDL/TG/HDL）？" },
  { id:"meds_now",   labelEn:"Current statin/meds",  labelZh:"目前使用哪些降脂藥？" },
  { id:"adherence",  labelEn:"Adherence",            labelZh:"服藥是否規律？" },
  { id:"muscle_sx",  labelEn:"Muscle symptoms",      labelZh:"有無肌肉痠痛、無力？" },

  // ===== ESC/EAS Risk Factors =====
  { id:"esc_htn",     labelEn:"Hypertension",       labelZh:"是否有高血壓？" },
  { id:"esc_dm",      labelEn:"Diabetes mellitus",  labelZh:"是否有糖尿病？" },
  { id:"esc_smoke",   labelEn:"Smoking",            labelZh:"目前是否吸菸？" },
  { id:"esc_fh",      labelEn:"Family history",     labelZh:"早發 ASCVD 家族史？（男<55、女<65）" },
  { id:"esc_hdl",     labelEn:"Low HDL",            labelZh:"HDL 偏低？（男<40、女<45）" },
  { id:"esc_ckd",     labelEn:"CKD",                labelZh:"慢性腎臟病（eGFR <60）？" },
  { id:"esc_obesity", labelEn:"Obesity",            labelZh:"肥胖／中心型肥胖？" },
  { id:"esc_lpa",     labelEn:"Lp(a)",              labelZh:"Lp(a) ≥50 mg/dL 或 ≥125 nmol/L？" }

    ],
    ddx: [
      "Well-controlled dyslipidemia",
      "Uncontrolled dyslipidemia",
      "Statin-associated muscle symptoms",
      "Metabolic syndrome"
    ]
  },

  med_refill: {
    nameEn: "medication refill",
    history: [
      { id:"chronic_dz", labelEn:"Chronic diseases",   labelZh:"主要慢性病有哪些？（高血壓、糖尿病、高血脂…）" },
      { id:"control",    labelEn:"Disease control",    labelZh:"自覺控制情形如何？" },
      { id:"side_fx",    labelEn:"Side effects",       labelZh:"用藥後有無不舒服或副作用？" },
      { id:"adherence",  labelEn:"Adherence",          labelZh:"服藥是否規律？" }
    ],
    ddx: [
      "Stable chronic disease on long-term medication",
      "Suboptimal adherence to medication",
      "Medication side effect"
    ]
  },

  // ---- Psych / sleep ----
  insomnia: {
    nameEn: "insomnia",
    history: [
      { id:"duration",  labelEn:"Duration",            labelZh:"睡不好多久了？" },
      { id:"type",      labelEn:"Type",                labelZh:"主要是入睡困難、中途醒，還是太早醒？" },
      { id:"hours",     labelEn:"Sleep hours",         labelZh:"平均一晚睡幾小時？" },
      { id:"day_fx",    labelEn:"Daytime function",    labelZh:"白天精神、專注力如何？" },
      { id:"psych",     labelEn:"Mood/anxiety",        labelZh:"最近心情、焦慮、壓力狀況？" },
      { id:"substance", labelEn:"Caffeine/alcohol",    labelZh:"咖啡因、茶、能量飲料、酒精使用情形？" }
    ],
    ddx: [
      "Primary insomnia",
      "Insomnia related to anxiety or depression",
      "Poor sleep hygiene",
      "Substance-related insomnia (caffeine, alcohol)"
    ]
  },

  anxiety: {
    nameEn: "anxiety",
    history: [
      { id:"duration",  labelEn:"Duration",                labelZh:"焦慮/緊張多久了？" },
      { id:"worry",     labelEn:"Main worries",            labelZh:"主要在擔心什麼事情？" },
      { id:"somatic",   labelEn:"Physical symptoms",       labelZh:"心悸、胸悶、喘、發抖、腸胃不適等？" },
      { id:"triggers",  labelEn:"Triggers",                labelZh:"有無特定誘發情境/壓力源？" },
      { id:"sleep",     labelEn:"Sleep",                   labelZh:"對睡眠有無影響？" },
      { id:"function",  labelEn:"Functional impairment",   labelZh:"是否影響工作、人際或日常生活？" }
    ],
    ddx: [
      "Generalized anxiety disorder",
      "Adjustment disorder with anxiety",
      "Panic disorder",
      "Somatic symptom related disorder"
    ]
  },

  depression: {
    nameEn: "depressive symptoms",
    history: [
      { id:"duration",  labelEn:"Duration",              labelZh:"心情低落/沒興趣多久了？" },
      { id:"mood",      labelEn:"Mood",                  labelZh:"心情大部分時間如何？" },
      { id:"anhedonia", labelEn:"Loss of interest",      labelZh:"以前有興趣的事情現在還有興趣嗎？" },
      { id:"bio",       labelEn:"Sleep/appetite/energy", labelZh:"睡眠、食慾、體重、精神體力的變化？" },
      { id:"guilt",     labelEn:"Guilt/worthlessness",   labelZh:"是否常覺得自己沒用或罪惡？" },
      { id:"si",        labelEn:"Suicidal ideation",     labelZh:"有沒有出現不想活、想傷害自己的念頭？" }
    ],
    ddx: [
      "Major depressive disorder",
      "Adjustment disorder with depressed mood",
      "Persistent depressive disorder",
      "Depression secondary to medical illness"
    ]
  },

  // ---- GU / skin ----
  dysuria: {
    nameEn: "dysuria / UTI symptoms",
    history: [
      { id:"duration",  labelEn:"Duration",          labelZh:"排尿疼痛/頻尿多久了？" },
      { id:"frequency", labelEn:"Frequency/urgency", labelZh:"小便是否頻繁、急迫？" },
      { id:"fever",     labelEn:"Fever/chills",      labelZh:"有無發燒、寒顫？" },
      { id:"flank",     labelEn:"Flank pain",        labelZh:"有無側腹/腰痛？" },
      { id:"hematuria", labelEn:"Hematuria",         labelZh:"有沒有血尿？" },
      { id:"sex",       labelEn:"Sexual history",    labelZh:"最近性行為情形？新伴侶？" }
    ],
    ddx: [
      "Acute uncomplicated cystitis",
      "Pyelonephritis",
      "Urethritis / STI",
      "Noninfectious irritation"
    ]
  },

  vaginal_discharge: {
    nameEn: "vaginal discharge",
    history: [
      { id:"duration",  labelEn:"Duration",            labelZh:"分泌物異常多久？" },
      { id:"character", labelEn:"Color/odor/amount",   labelZh:"顏色、氣味、量如何？" },
      { id:"sx",        labelEn:"Itching/pain",        labelZh:"有無搔癢、疼痛、性交痛？" },
      { id:"bleeding",  labelEn:"Bleeding",            labelZh:"有無異常出血？" },
      { id:"sex",       labelEn:"Sexual history",      labelZh:"最近性行為/新性伴侶？保險套使用？" },
      { id:"lmp",       labelEn:"LMP / pregnancy risk",labelZh:"最近一次月經、是否可能懷孕？" }
    ],
    ddx: [
      "Vulvovaginal candidiasis",
      "Bacterial vaginosis",
      "Trichomoniasis",
      "Cervicitis / STI"
    ]
  },

  rash: {
    nameEn: "rash / skin lesion",
    history: [
      { id:"duration",  labelEn:"Duration",            labelZh:"皮疹/紅疹多久了？" },
      { id:"location",  labelEn:"Location",            labelZh:"分布在哪些部位？" },
      { id:"character", labelEn:"Character",           labelZh:"性質（紅、丘疹、水泡、脫屑等）？" },
      { id:"itch",      labelEn:"Itch/pain",           labelZh:"是否癢或痛？" },
      { id:"trigger",   labelEn:"Trigger/exposure",    labelZh:"是否接觸新藥物、食物、清潔用品或戶外活動？" },
      { id:"systemic",  labelEn:"Systemic symptoms",   labelZh:"有無發燒、關節痛、全身不適？" }
    ],
    ddx: [
      "Allergic/contact dermatitis",
      "Eczema",
      "Urticaria",
      "Drug eruption",
      "Viral exanthem"
    ]
  },

  // ---- Health check abnormality ----
  abnormal_lft: {
    nameEn: "abnormal liver function from health check",
    history: [
      { id:"duration",  labelEn:"Duration",           labelZh:"第一次發現肝功能異常是什麼時候？" },
      { id:"values",    labelEn:"AST/ALT/others",     labelZh:"肝功能數值（AST/ALT、GGT 等）？" },
      { id:"symptoms",  labelEn:"Symptoms",           labelZh:"有無黃疸、倦怠、腹痛、噁心？" },
      { id:"alcohol",   labelEn:"Alcohol use",        labelZh:"平常喝酒頻率與量？" },
      { id:"meds_herb", labelEn:"Meds/herbs/supp",    labelZh:"近期是否有新藥物、中草藥或保健品？" },
      { id:"risk",      labelEn:"Viral hepatitis risk",labelZh:"是否有輸血史、針頭暴露、家族B/C肝？" }
    ],
    ddx: [
      "Nonalcoholic fatty liver disease",
      "Alcohol-related liver injury",
      "Drug-induced liver injury",
      "Chronic viral hepatitis"
    ]
  },

  abnormal_renal: {
    nameEn: "abnormal renal function from health check",
    history: [
      { id:"duration",  labelEn:"Duration / trend",      labelZh:"腎功能異常多久？有無過去檢查趨勢？" },
      { id:"values",    labelEn:"Cr/eGFR/UA/protein",    labelZh:"肌酐、eGFR、尿蛋白/尿潛血數值？" },
      { id:"sx",        labelEn:"Symptoms",              labelZh:"有無水腫、泡泡尿、尿量改變、噁心？" },
      { id:"htn_dm",    labelEn:"HTN/DM history",        labelZh:"是否有高血壓、糖尿病病史？" },
      { id:"nephrotox", labelEn:"Nephrotoxic meds/NSAID",labelZh:"是否常用止痛藥（NSAID）或其他腎毒性藥物？" }
    ],
    ddx: [
      "Chronic kidney disease related to hypertension or diabetes",
      "Acute kidney injury (medication or volume related)",
      "Primary glomerular disease"
    ]
  }
};

const ccSelect    = document.getElementById("ccSelect");
const historyArea = document.getElementById("historyArea");
const output      = document.getElementById("output");
  
// ========================== Sex 選擇按鈕 ==========================
const sexHidden = document.getElementById("sex");
const sexButtons = document.querySelectorAll(".sex-btn");

sexButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    // 1) 設定隱藏欄位的值
    sexHidden.value = btn.dataset.value; // "M" or "F"

    // 2) 更新按鈕外觀（只有一個是 active）
    sexButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  });
});
  
// ========================== Build history UI ==========================
ccSelect.addEventListener("change", () => {
  const key = ccSelect.value;
  historyArea.innerHTML = "";

  if (!key) {
    historyArea.textContent = "Select a chief complaint.";
    return;
  }

  const tpl = templates[key];
  tpl.history.forEach(q => {
    const label = document.createElement("label");
    label.textContent = q.labelZh;
    const input = document.createElement("input");
    input.type = "text";
    input.id = "q_" + q.id;
    input.style.width = "80%";
    historyArea.appendChild(label);
    historyArea.appendChild(input);
  });
});

// ========================== Helper: build PI sentence ==========================
function buildPiSentence(key, tpl, answers, age, sex) {
  let sexWord = "";
  if (sex === "M") sexWord = "male";
  else if (sex === "F") sexWord = "female";

  let start = "";
  if (age && sexWord) {
    start = `${age}-year-old ${sexWord}`;
  } else if (age) {
    start = `${age}-year-old patient`;
  } else if (sexWord) {
    start = `A ${sexWord} patient`;
  } else {
    start = "The patient";
  }

  let sentence = `${start} with ${tpl.nameEn}`;
  if (answers["duration"]) sentence += ` for ${answers["duration"]}`;
  sentence += ",";

  const fragments = [];

  if (key === "sore_throat") {
    if (answers["fever"])      fragments.push(`fever up to ${answers["fever"]}`);
    if (answers["rhinorrhea"]) fragments.push(`${answers["rhinorrhea"]} rhinorrhea`);
    if (answers["odynophagia"])fragments.push("odynophagia");
    if (answers["cough"])      fragments.push(`${answers["cough"]} cough`);
    if (answers["tocc"])       fragments.push(`TOCC: ${answers["tocc"]}`);
  } else if (key === "fever") {
    if (answers["max_temp"])   fragments.push(`fever up to ${answers["max_temp"]}`);
    if (answers["resp"])       fragments.push(`respiratory symptoms: ${answers["resp"]}`);
    if (answers["gi"])         fragments.push(`GI symptoms: ${answers["gi"]}`);
    if (answers["urinary"])    fragments.push(`urinary symptoms: ${answers["urinary"]}`);
    if (answers["travel"])     fragments.push(`travel/TOCC: ${answers["travel"]}`);
  } else if (key === "abd_pain") {
  if (answers["provocation"]) fragments.push(`worse with ${answers["provocation"]}`);
  if (answers["palliation"])  fragments.push(`relieved by ${answers["palliation"]}`);
  if (answers["quality"])     fragments.push(`${answers["quality"]} pain`);
  if (answers["pain_score"])  fragments.push(`pain score ${answers["pain_score"]}/10`);

  if (answers["location"])    fragments.push(`located at ${answers["location"]}`);
  if (answers["radiation"])   fragments.push(`radiating to ${answers["radiation"]}`);

  if (answers["onset"])       fragments.push(`onset pattern: ${answers["onset"]}`);

  if (answers["gi"])          fragments.push(`GI symptoms: ${answers["gi"]}`);
  if (answers["bleed"])       fragments.push(`GI bleeding: ${answers["bleed"]}`);
  if (answers["urinary"])     fragments.push(`urinary symptoms: ${answers["urinary"]}`);
  if (answers["gyne"])        fragments.push(`gynecologic history: ${answers["gyne"]}`);
  } else if (key === "chest_pain") {
    if (answers["onset"])       fragments.push(`onset ${answers["onset"]}`);
    if (answers["first_time"])  fragments.push(`episode pattern: ${answers["first_time"]}`);
    if (answers["pattern"])     fragments.push(`course is ${answers["pattern"]}`);

    if (answers["location"])    fragments.push(`located at ${answers["location"]}`);
    if (answers["depth"])       fragments.push(`pain feels ${answers["depth"]}`);
    if (answers["quality"])     fragments.push(`${answers["quality"]} chest pain`);
    if (answers["severity"])    fragments.push(`severity ${answers["severity"]}/10`);

    if (answers["radiation"])   fragments.push(`radiating to ${answers["radiation"]}`);

    if (answers["exertion"])    fragments.push(`worsened by exertion: ${answers["exertion"]}`);
    if (answers["pleuritic"])   fragments.push(`pleuritic component: ${answers["pleuritic"]}`);
    if (answers["rest_relief"]) fragments.push(`relieved by rest: ${answers["rest_relief"]}`);
    if (answers["meal_relief"]) fragments.push(`relation to meals/swallowing: ${answers["meal_relief"]}`);

    if (answers["sob"])         fragments.push(`associated SOB: ${answers["sob"]}`);
    if (answers["diaphoresis"]) fragments.push(`diaphoresis: ${answers["diaphoresis"]}`);
    if (answers["nausea"])      fragments.push(`nausea/vomiting: ${answers["nausea"]}`);
    if (answers["near_syncope"])fragments.push(`dizziness/near-syncope: ${answers["near_syncope"]}`);
    if (answers["cough_hemoptysis"]) fragments.push(`cough/hemoptysis: ${answers["cough_hemoptysis"]}`);
    if (answers["fever"])       fragments.push(`fever: ${answers["fever"]}`);

    if (answers["cv_risk"])     fragments.push(`CV risk factors: ${answers["cv_risk"]}`);
    if (answers["pe_risk"])     fragments.push(`PE risk: ${answers["pe_risk"]}`);
    if (answers["dissection"])  fragments.push(`aortic dissection clues: ${answers["dissection"]}`);
    if (answers["gi"])          fragments.push(`GI features: ${answers["gi"]}`);
    if (answers["msk"])         fragments.push(`MSK chest wall tenderness/movement related: ${answers["msk"]}`);

    if (answers["nitro"])       fragments.push(`response to nitroglycerin: ${answers["nitro"]}`);
    if (answers["drugs"])       fragments.push(`substance use (cocaine/stimulant): ${answers["drugs"]}`);
  } else if (key === "sob") {
    if (answers["exertional"]) fragments.push(`exertional dyspnea: ${answers["exertional"]}`);
    if (answers["orthopnea"])  fragments.push(`orthopnea/PND: ${answers["orthopnea"]}`);
    if (answers["cough"])      fragments.push(`cough/sputum: ${answers["cough"]}`);
    if (answers["wheezing"])   fragments.push(`wheezing: ${answers["wheezing"]}`);
    if (answers["fever"])      fragments.push(`fever: ${answers["fever"]}`);
    if (answers["leg_swelling"])fragments.push(`leg swelling: ${answers["leg_swelling"]}`);
} else if (key === "headache") {
    if (answers["onset"])          fragments.push(`onset: ${answers["onset"]}`);
    if (answers["sudden"])         fragments.push(`onset nature: ${answers["sudden"]}`);
    if (answers["first_time"])     fragments.push(`first episode: ${answers["first_time"]}`);
    if (answers["pattern"])        fragments.push(`pattern: ${answers["pattern"]}`);
    if (answers["worst_time"])     fragments.push(`worst time: ${answers["worst_time"]}`);

    if (answers["location"])       fragments.push(`location: ${answers["location"]}`);
    if (answers["quality"])        fragments.push(`quality: ${answers["quality"]}`);
    if (answers["severity"])       fragments.push(`severity: ${answers["severity"]}/10`);

    if (answers["trigger"])        fragments.push(`triggers: ${answers["trigger"]}`);
    if (answers["relief"])         fragments.push(`relieved by: ${answers["relief"]}`);

    if (answers["nausea"])         fragments.push(`nausea/vomiting: ${answers["nausea"]}`);
    if (answers["photophobia"])    fragments.push(`photophobia/phonophobia: ${answers["photophobia"]}`);
    if (answers["aura"])           fragments.push(`aura/visual: ${answers["aura"]}`);
    if (answers["fever"])          fragments.push(`fever/neck stiffness: ${answers["fever"]}`);
    if (answers["neuro"])          fragments.push(`neuro deficits: ${answers["neuro"]}`);

    if (answers["radiation"])      fragments.push(`radiation: ${answers["radiation"]}`);

    if (answers["past_hx"])        fragments.push(`past headache hx: ${answers["past_hx"]}`);
    if (answers["lifestyle"])      fragments.push(`lifestyle triggers: ${answers["lifestyle"]}`);

    if (answers["meds"])           fragments.push(`medications: ${answers["meds"]}`);
    if (answers["systemic"])       fragments.push(`systemic risks: ${answers["systemic"]}`);

  } else if (key === "dizziness") {
    if (answers["type"])      fragments.push(`described as ${answers["type"]}`);
    if (answers["onset"])     fragments.push(`onset ${answers["onset"]}`);
    if (answers["duration"])  fragments.push(`episodes lasting ${answers["duration"]}`);
    if (answers["pattern"])   fragments.push(`course is ${answers["pattern"]}`);
    if (answers["position"])  fragments.push(`triggered by ${answers["position"]}`);
    if (answers["spinning"])  fragments.push(`spinning sensation: ${answers["spinning"]}`);
    if (answers["gait"])      fragments.push(`gait instability: ${answers["gait"]}`);
    if (answers["hearing"])   fragments.push(`auditory symptoms: ${answers["hearing"]}`);
    if (answers["nausea"])    fragments.push(`nausea/vomiting: ${answers["nausea"]}`);
    if (answers["neuro"])     fragments.push(`neurologic deficits: ${answers["neuro"]}`);
    if (answers["cardiac"])   fragments.push(`presyncope/cardiac symptoms: ${answers["cardiac"]}`);
    if (answers["risk"])      fragments.push(`risk factors: ${answers["risk"]}`);
    if (answers["uri"])       fragments.push(`recent URI: ${answers["uri"]}`);
    if (answers["meds"])      fragments.push(`recent medications: ${answers["meds"]}`);
  } else if (key === "palpitations") {
    if (answers["pattern"])    fragments.push(`irregularity: ${answers["pattern"]}`);
    if (answers["onset"])      fragments.push(`onset/offset: ${answers["onset"]}`);
    if (answers["triggers"])   fragments.push(`triggers: ${answers["triggers"]}`);
    if (answers["chest_pain"]) fragments.push(`associated chest discomfort: ${answers["chest_pain"]}`);
    if (answers["dizziness"])  fragments.push(`dizziness/syncope: ${answers["dizziness"]}`);
    if (answers["thyroid"])    fragments.push(`thyroid symptoms: ${answers["thyroid"]}`);
  } else if (key === "cough") {
    if (answers["productive"]) fragments.push(`cough ${answers["productive"]}`);
    if (answers["color"])      fragments.push(`sputum color: ${answers["color"]}`);
    if (answers["fever"])      fragments.push(`fever: ${answers["fever"]}`);
    if (answers["wheezing"])   fragments.push(`wheezing: ${answers["wheezing"]}`);
    if (answers["gerd"])       fragments.push(`GERD symptoms: ${answers["gerd"]}`);
    if (answers["acei"])       fragments.push(`ACEi use: ${answers["acei"]}`);
    if (answers["smoking"])    fragments.push(`smoking history: ${answers["smoking"]}`);
  } else if (key === "abd_bloating") {
    if (answers["pain"])       fragments.push(`with abdominal pain: ${answers["pain"]}`);
    if (answers["bowel"])      fragments.push(`bowel habit change: ${answers["bowel"]}`);
    if (answers["nausea"])     fragments.push(`nausea/vomiting: ${answers["nausea"]}`);
    if (answers["weight"])     fragments.push(`weight loss: ${answers["weight"]}`);
    if (answers["ascites_risk"])fragments.push(`liver disease/alcohol: ${answers["ascites_risk"]}`);
  } else if (key === "diarrhea") {
    if (answers["frequency"])  fragments.push(`stool frequency: ${answers["frequency"]}`);
    if (answers["watery"])     fragments.push(`stool character: ${answers["watery"]}`);
    if (answers["fever"])      fragments.push(`fever: ${answers["fever"]}`);
    if (answers["abd_pain"])   fragments.push(`abdominal pain: ${answers["abd_pain"]}`);
    if (answers["dehydrate"])  fragments.push(`dehydration signs: ${answers["dehydrate"]}`);
    if (answers["travel"])     fragments.push(`travel/food exposure: ${answers["travel"]}`);
    if (answers["abx"])        fragments.push(`recent antibiotics: ${answers["abx"]}`);
  } else if (key === "constipation") {
    if (answers["frequency"])  fragments.push(`stool frequency: ${answers["frequency"]}`);
    if (answers["hard"])       fragments.push(`hard stool: ${answers["hard"]}`);
    if (answers["strain"])     fragments.push(`straining: ${answers["strain"]}`);
    if (answers["blood"])      fragments.push(`blood on stool: ${answers["blood"]}`);
    if (answers["meds"])       fragments.push(`constipating meds: ${answers["meds"]}`);
    if (answers["thyroid"])    fragments.push(`hypothyroid symptoms: ${answers["thyroid"]}`);
  } else if (key === "edema") {
    if (answers["laterality"]) fragments.push(`edema ${answers["laterality"]}`);
    if (answers["pain"])       fragments.push(`leg pain/tenderness: ${answers["pain"]}`);
    if (answers["sob"])        fragments.push(`associated SOB: ${answers["sob"]}`);
    if (answers["nocturia"])   fragments.push(`nocturia: ${answers["nocturia"]}`);
    if (answers["hx"])         fragments.push(`cardiac/renal/liver history: ${answers["hx"]}`);
    if (answers["travel"])     fragments.push(`recent immobilization/travel: ${answers["travel"]}`);
  } else if (key === "fatigue") {
    if (answers["sleep"])      fragments.push(`sleep quality: ${answers["sleep"]}`);
    if (answers["snore"])      fragments.push(`snoring/apnea: ${answers["snore"]}`);
    if (answers["mood"])       fragments.push(`mood/anhedonia: ${answers["mood"]}`);
    if (answers["anemia"])     fragments.push(`anemia symptoms: ${answers["anemia"]}`);
    if (answers["thyroid"])    fragments.push(`thyroid symptoms: ${answers["thyroid"]}`);
    if (answers["chronic_dz"]) fragments.push(`chronic diseases: ${answers["chronic_dz"]}`);
    } else if (key === "weight_loss") {
    // 開頭：刻意 / 非刻意減重
    if (answers["amount"]) {
      const intentPhrase = answers["intentional"]
        ? `${answers["intentional"]} weight loss of ${answers["amount"]}`
        : `weight loss of ${answers["amount"]}`;
      fragments.push(intentPhrase);
    } else if (answers["intentional"]) {
      fragments.push(`${answers["intentional"]} weight loss`);
    }

    // Appetite & intake
    if (answers["appetite"])      fragments.push(`appetite: ${answers["appetite"]}`);
    if (answers["intake"])        fragments.push(`dietary intake: ${answers["intake"]}`);
    if (answers["early_satiety"]) fragments.push(`early satiety: ${answers["early_satiety"]}`);

    // B symptoms
    if (answers["b_symptoms"])    fragments.push(`fever/night sweats: ${answers["b_symptoms"]}`);
    if (answers["fatigue"])       fragments.push(`fatigue: ${answers["fatigue"]}`);

    // GI
    if (answers["dysphagia"])     fragments.push(`dysphagia: ${answers["dysphagia"]}`);
    if (answers["gi"])            fragments.push(`GI symptoms: ${answers["gi"]}`);
    if (answers["bowel_change"])  fragments.push(`change of bowel habit: ${answers["bowel_change"]}`);
    if (answers["gi_bleed"])      fragments.push(`GI bleeding: ${answers["gi_bleed"]}`);

    // Endocrine
    if (answers["hyperthyroid"])  fragments.push(`hyperthyroid symptoms: ${answers["hyperthyroid"]}`);
    if (answers["dm"])            fragments.push(`DM triad: ${answers["dm"]}`);

    // Psych
    if (answers["mood"])          fragments.push(`mood/stress: ${answers["mood"]}`);
    if (answers["eating_dis"])    fragments.push(`eating behavior: ${answers["eating_dis"]}`);

    // Meds & substances
    if (answers["meds"])          fragments.push(`recent medications: ${answers["meds"]}`);
    if (answers["substance"])     fragments.push(`substance use: ${answers["substance"]}`);

    // Malignancy / infection
    if (answers["resp"])          fragments.push(`respiratory symptoms: ${answers["resp"]}`);
    if (answers["tb_contact"])    fragments.push(`TB contact: ${answers["tb_contact"]}`);
    if (answers["lump"])          fragments.push(`lumps/lymph nodes: ${answers["lump"]}`);

    // Function
    if (answers["function"])      fragments.push(`functional status: ${answers["function"]}`);
} else if (key === "fuo") {
    if (answers["pattern"])    fragments.push(`fever pattern: ${answers["pattern"]}`);
    if (answers["localizing"]) fragments.push(`localizing symptoms: ${answers["localizing"]}`);
    if (answers["weight"])     fragments.push(`weight loss/night sweats: ${answers["weight"]}`);
    if (answers["travel"])     fragments.push(`travel/exposure: ${answers["travel"]}`);
    if (answers["immune"])     fragments.push(`immunocompromised: ${answers["immune"]}`);
    } else if (key === "htn_fup") {
    if (answers["home_bp"])   fragments.push(`home BP around ${answers["home_bp"]}`);
    if (answers["meds_now"])  fragments.push(`on antihypertensive meds: ${answers["meds_now"]}`);
    if (answers["adherence"]) fragments.push(`adherence: ${answers["adherence"]}`);
    if (answers["symptoms"])  fragments.push(`symptoms: ${answers["symptoms"]}`);

  } else if (key === "dm_fup") {
    if (answers["home_glu"])  fragments.push(`home glucose around ${answers["home_glu"]}`);
    if (answers["a1c"])       fragments.push(`last HbA1c: ${answers["a1c"]}`);
    if (answers["meds_now"])  fragments.push(`on diabetes meds: ${answers["meds_now"]}`);
    if (answers["adherence"]) fragments.push(`adherence: ${answers["adherence"]}`);
    if (answers["symptoms"])  fragments.push(`symptoms: ${answers["symptoms"]}`);

  } else if (key === "lipid_fup") {
    if (answers["lipid_val"]) fragments.push(`recent lipid profile: ${answers["lipid_val"]}`);
    if (answers["meds_now"])  fragments.push(`on lipid-lowering meds: ${answers["meds_now"]}`);
    if (answers["adherence"]) fragments.push(`adherence: ${answers["adherence"]}`);
    if (answers["muscle_sx"]) fragments.push(`muscle symptoms: ${answers["muscle_sx"]}`);
    if (answers["lifestyle"]) fragments.push(`lifestyle: ${answers["lifestyle"]}`);

  } else if (key === "med_refill") {
    if (answers["chronic_dz"]) fragments.push(`chronic diseases: ${answers["chronic_dz"]}`);
    if (answers["control"])    fragments.push(`self-perceived control: ${answers["control"]}`);
    if (answers["side_fx"])    fragments.push(`side effects: ${answers["side_fx"]}`);
    if (answers["adherence"])  fragments.push(`adherence: ${answers["adherence"]}`);

  } else if (key === "insomnia") {
    if (answers["type"])      fragments.push(`insomnia type: ${answers["type"]}`);
    if (answers["hours"])     fragments.push(`sleep about ${answers["hours"]} hours per night`);
    if (answers["day_fx"])    fragments.push(`daytime function: ${answers["day_fx"]}`);
    if (answers["psych"])     fragments.push(`mood/anxiety: ${answers["psych"]}`);
    if (answers["substance"]) fragments.push(`caffeine/alcohol use: ${answers["substance"]}`);

  } else if (key === "anxiety") {
    if (answers["worry"])     fragments.push(`main worries: ${answers["worry"]}`);
    if (answers["somatic"])   fragments.push(`physical symptoms: ${answers["somatic"]}`);
    if (answers["triggers"])  fragments.push(`triggers: ${answers["triggers"]}`);
    if (answers["sleep"])     fragments.push(`sleep impact: ${answers["sleep"]}`);
    if (answers["function"])  fragments.push(`functional impact: ${answers["function"]}`);

  } else if (key === "depression") {
    if (answers["mood"])      fragments.push(`mood: ${answers["mood"]}`);
    if (answers["anhedonia"]) fragments.push(`loss of interest: ${answers["anhedonia"]}`);
    if (answers["bio"])       fragments.push(`sleep/appetite/energy: ${answers["bio"]}`);
    if (answers["guilt"])     fragments.push(`guilt/worthlessness: ${answers["guilt"]}`);
    if (answers["si"])        fragments.push(`suicidal ideation: ${answers["si"]}`);

  } else if (key === "dysuria") {
    if (answers["frequency"]) fragments.push(`frequency/urgency: ${answers["frequency"]}`);
    if (answers["fever"])     fragments.push(`fever/chills: ${answers["fever"]}`);
    if (answers["flank"])     fragments.push(`flank pain: ${answers["flank"]}`);
    if (answers["hematuria"]) fragments.push(`hematuria: ${answers["hematuria"]}`);
    if (answers["sex"])       fragments.push(`sexual history: ${answers["sex"]}`);

  } else if (key === "vaginal_discharge") {
    if (answers["character"]) fragments.push(`discharge: ${answers["character"]}`);
    if (answers["sx"])        fragments.push(`itching/pain: ${answers["sx"]}`);
    if (answers["bleeding"])  fragments.push(`bleeding: ${answers["bleeding"]}`);
    if (answers["sex"])       fragments.push(`sexual history: ${answers["sex"]}`);
    if (answers["lmp"])       fragments.push(`LMP/pregnancy risk: ${answers["lmp"]}`);

  } else if (key === "rash") {
    if (answers["location"])  fragments.push(`rash at ${answers["location"]}`);
    if (answers["character"]) fragments.push(`${answers["character"]}`);
    if (answers["itch"])      fragments.push(`itch/pain: ${answers["itch"]}`);
    if (answers["trigger"])   fragments.push(`possible triggers: ${answers["trigger"]}`);
    if (answers["systemic"])  fragments.push(`systemic symptoms: ${answers["systemic"]}`);

  } else if (key === "abnormal_lft") {
    if (answers["values"])    fragments.push(`liver tests: ${answers["values"]}`);
    if (answers["symptoms"])  fragments.push(`symptoms: ${answers["symptoms"]}`);
    if (answers["alcohol"])   fragments.push(`alcohol use: ${answers["alcohol"]}`);
    if (answers["meds_herb"]) fragments.push(`meds/herbs/supplements: ${answers["meds_herb"]}`);
    if (answers["risk"])      fragments.push(`viral hepatitis risk: ${answers["risk"]}`);

  } else if (key === "abnormal_renal") {
    if (answers["values"])    fragments.push(`renal tests: ${answers["values"]}`);
    if (answers["sx"])        fragments.push(`symptoms: ${answers["sx"]}`);
    if (answers["htn_dm"])    fragments.push(`HTN/DM history: ${answers["htn_dm"]}`);
    if (answers["nephrotox"]) fragments.push(`nephrotoxic meds/NSAID: ${answers["nephrotox"]}`);

  } else {
    Object.keys(answers).forEach(id => {
      if (id === "duration") return;
      if (answers[id]) fragments.push(`${id}: ${answers[id]}`);
    });
  }

  if (fragments.length > 0) {
    sentence += " " + fragments.join(", ") + ".";
  } else {
    sentence += " .";
  }
  return sentence;
}

// ========================== Generate SOAP ==========================
document.getElementById("generateBtn").addEventListener("click", () => {
  const key = ccSelect.value;
  if (!key) {
    alert("Select chief complaint first");
    return;
  }

  const tpl = templates[key];

  // ===== History answers =====
  const answers = {};
  tpl.history.forEach(q => {
    answers[q.id] = (document.getElementById("q_" + q.id)?.value || "").trim();
  });

  // ===== Basic info =====
  const age = document.getElementById("age").value;
  // 如果你還是用下拉選單就改成 "sex"
  const sex = sexHidden?.value || "";

  // ===== Past History Fields =====
  const ph   = (document.getElementById("ph")?.value || "").trim() || "denied";
  const al   = (document.getElementById("allergy")?.value || "").trim() || "NKA";
  const med  = (document.getElementById("med")?.value || "").trim() || "denied";
  const fh   = (document.getElementById("fh")?.value || "").trim() || "no contributory";
  const surg = (document.getElementById("surg")?.value || "").trim() || "denied";
  const sh   = (document.getElementById("sh")?.value || "").trim() ||
               "denied alcohol, betel or cigarette";

  // ===== S =====
  let S = "S:\n";
  const ccLine =
    `CC: ${tpl.nameEn.charAt(0).toUpperCase() + tpl.nameEn.slice(1)}` +
    (answers["duration"] ? ` for ${answers["duration"]}` : "");
  S += ccLine + "\n\n";

  const piSentence = buildPiSentence(key, tpl, answers, age, sex);
  S += "PI:\n" + piSentence + "\n\n";

  S += `PH: ${ph}\n`;
  S += `Allergy: ${al}\n`;
  S += `Med: ${med}\n`;
  S += `FH: ${fh}\n`;
  if (surg) {
    S += `Surgery: ${surg}\n`;
  }
  S += `SH: ${sh}\n\n`;

  // ===== O (簡單模板，之後可自己改) =====
  let O = "O:\nVS: T / BP\nHEENT:\nChest:\n\n";

  // 若你已經刪掉 DDx，就不要再加 D 了
  const note = S + O;

  output.value = note;
});

// ========================== OpenEvidence: copy full SOAP ==========================
document.getElementById("openEvidenceBtn").addEventListener("click", () => {
  const text = output.value.trim();
  if (!text) {
    alert("請先按『Generate SOAP』產生病例，再送到 OpenEvidence。");
    return;
  }

  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      alert("已將完整病例複製到剪貼簿，開啟 OpenEvidence 後直接貼上即可。");
    }).catch(() => {
      alert("無法自動複製，請在本頁手動全選複製後再貼到 OpenEvidence。");
    });
  } else {
    alert("請在本頁手動全選複製後再貼到 OpenEvidence。");
  }

  window.open("https://www.openevidence.com/", "_blank");
});

// ========================== ChatGPT: copy full SOAP （電腦用） ==========================
document.getElementById("chatgptBtn").addEventListener("click", () => {
  const text = output.value.trim();
  if (!text) {
    alert("請先按『Generate SOAP』產生病例，再送到 ChatGPT。");
    return;
  }

  const promptText =
`You are an internal medicine consultant.
Here is a clinic SOAP note:

${text}

Please:

1) Rewrite the "PI" (present illness) section into fluent, concise English, as if written by a native internal-medicine physician for a clinic note.

2) List likely diagnoses with brief reasoning.

3) Suggest key physical exams and tests.

4) Provide an initial management plan.

Format your answer in plain text with clear headings, like:

Refined PI:
...

1) Likely diagnoses:
- ...

2) Key physical exams and tests:
- ...

3) Initial management plan:
- ...
`;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(promptText).then(() => {
      alert("已將 ChatGPT prompt 複製到剪貼簿，開啟 ChatGPT 後直接貼上即可。");
    }).catch(() => {
      alert("無法自動複製，請在本頁手動全選複製後再貼到 ChatGPT。");
    });
  } else {
    alert("請在本頁手動複製後再貼到 ChatGPT。");
  }

  window.open("https://chatgpt.com/", "_blank");
});


// ========================== Ask AI via backend (silent mode) ==========================
const askAiBtn  = document.getElementById("askAiBtn");
const aiStatus  = document.getElementById("aiStatus");
const aiResult  = document.getElementById("aiResult");
const freeAiBtn = document.getElementById("freeAiBtn");

const AI_API_URL = "/api/clinic-ai";
const hxSuggestBtn = document.getElementById("hxSuggestBtn");

// ----------- 共用函式：丟文字給 AI，顯示回覆 -----------
async function callAIWithText(text, mode) {
  const clean = (text || "").trim();
  if (!clean) {
    alert("沒有內容可送出，請先輸入或產生內容。");
    return;
  }

  aiStatus.textContent = "Loading...";
  aiResult.textContent = "";

  try {
    const resp = await fetch(AI_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ soap: clean, mode })  // ✅ 多送 mode
    });

    if (!resp.ok) {
      aiStatus.textContent = "AI error (server side).";
      try {
        const errData = await resp.json();
        aiResult.textContent = JSON.stringify(errData, null, 2);
      } catch (e) {
        aiResult.textContent = "";
      }
      return;
    }

    const data = await resp.json();

    if (data.error) {
      aiStatus.textContent = "AI error: " + data.error;
      aiResult.textContent = data.detail || "";
      return;
    }

    aiStatus.textContent = "Suggestion:";
    aiResult.textContent = data.answer || "(no content)";
  } catch (e) {
    aiStatus.textContent = "Network or server error.";
    console.error(e);
  }
}


// ----------- Plan：從 Output SOAP 送出（走 guideline-heavy prompt） -----------
askAiBtn.addEventListener("click", () => {
  const text = output.value.trim();
  callAIWithText(text, "plan");
  
});
document.getElementById("chronicPlanBtn").addEventListener("click", async () => {
  const soap = document.getElementById("output").value;

  if (!soap.trim()) {
    alert("請先產生或貼上 SOAP 再使用此功能");
    return;
  }

  const res = await fetch("/api/clinic-ai", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      mode: "chronic_plan",
      soap: soap,
      max_output_tokens: 300
    })
  });

  const data = await res.json();

  if (data.error) {
    alert("AI error: " + data.error);
    return;
  }

  document.getElementById("aiResult").textContent = data.answer || "";
});


// ----------- Next step：從 Free note 送出（走 IM consultant prompt） -----------
freeAiBtn.addEventListener("click", () => {
  const text = document.getElementById("freeAiInput").value;
  callAIWithText(text, "im_consult");
});


// ----------- 問診建議按鈕：用 triage 模式，給初診怪怪主訴用 -----------
hxSuggestBtn.addEventListener("click", async () => {
  const complaint = (document.getElementById("freeAiInput").value || "").trim();
  const age = document.getElementById("age").value || "";
  const sex = document.getElementById("sex").value || "";

  if (!complaint) {
    alert("請先在 Free note 區塊輸入病人主訴或描述，再按「問診建議」。");
    return;
  }

  aiStatus.textContent = "Loading...";
  aiResult.textContent = "";

  try {
    const resp = await fetch(AI_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        mode: "triage",
        age,
        sex,
        complaint
      })
    });

    if (!resp.ok) {
      aiStatus.textContent = "AI error (server side).";
      try {
        const errData = await resp.json();
        aiResult.textContent = JSON.stringify(errData, null, 2);
      } catch (e) {
        aiResult.textContent = "";
      }
      return;
    }

    const data = await resp.json();

    if (data.error) {
      aiStatus.textContent = "AI error: " + data.error;
      aiResult.textContent = data.detail || "";
      return;
    }

    aiStatus.textContent = "問診建議：";
    aiResult.textContent = data.answer || "(no content)";
  } catch (e) {
    aiStatus.textContent = "Network or server error.";
    console.error(e);
  }
});

</script>

</body>
</html>
