<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Clinic SOAP Generator</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      line-height: 1.5;
      background: #000;
      color: #f5f5f5;
    }
    label { display: block; margin-top: 8px; }
    .section {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #111;
      border: 1px solid #333;
    }
    textarea {
      width: 100%;
      height: 260px;
      background: #111;
      color: #f5f5f5;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px;
    }
    select, input {
      padding: 4px;
      margin-top: 4px;
      background: #111;
      color: #f5f5f5;
      border: 1px solid #555;
      border-radius: 4px;
    }
    button {
      padding: 8px 14px;
      margin-top: 10px;
      margin-right: 6px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #888;
      background: #222;
      color: #f5f5f5;
    }
    button:hover {
      background: #333;
    }
    h2 {
      margin-bottom: 16px;
    }
  </style>
</head>

<body>

<h2>Clinic SOAP Generator</h2>

<div class="section">
  <strong>Patient Info</strong><br>
  Age: <input id="age" type="number" min="0" max="120" style="width: 60px;">
  Sex:
  <select id="sex">
    <option value="">--</option>
    <option value="M">Male</option>
    <option value="F">Female</option>
  </select>
</div>

<div class="section">
  <strong>Past / Allergy / Med / Family history</strong>
  <label>PH (past history):</label>
  <input id="ph" type="text" placeholder="e.g. HTN, DM；留白預設 denied">
  <label>Allergy:</label>
  <input id="allergy" type="text" placeholder="留白預設 NKA">
  <label>Med (regular medication):</label>
  <input id="med" type="text" placeholder="留白預設 denied">
  <label>FH (family history):</label>
  <input id="fh" type="text" placeholder="留白預設 no contributory">
</div>

<div class="section">
  <label>Chief complaint:</label>
  <select id="ccSelect">
    <option value="">Select</option>
    <option value="sore_throat">Sore throat</option>
    <option value="fever">Fever / URI</option>
    <option value="abd_pain">Abdominal pain</option>
  </select>
</div>

<div class="section">
  <strong>History questions:</strong>
  <div id="historyArea">Select a chief complaint to begin.</div>
</div>

<div class="section">
  <button id="generateBtn">Generate SOAP + Dx summary</button>
  <button id="openEvidenceBtn">Open in OpenEvidence</button>
</div>

<div class="section">
  <strong>Output (copy into HIS):</strong>
  <textarea id="output"></textarea>
</div>

<script>
// ========================== TEMPLATE DEFINITIONS ==========================
const templates = {
  sore_throat: {
    nameEn: "sore throat",
    history: [
      { id: "duration", labelEn: "Duration", labelZh: "症狀多久？（天）", type: "text" },
      { id: "fever", labelEn: "Fever history / maximal temperature", labelZh: "發燒？最高幾度？", type: "text" },
      { id: "cough", labelEn: "Cough", labelZh: "咳嗽？", type: "text" },
      { id: "rhinorrhea", labelEn: "Rhinorrhea / nasal congestion", labelZh: "流鼻水？鼻塞？", type: "text" },
      { id: "odynophagia", labelEn: "Odynophagia", labelZh: "吞嚥痛？", type: "text" },
      { id: "tocc", labelEn: "TOCC", labelZh: "接觸史 / 感染接觸者？", type: "text" }
    ],
    ddx: [
      "Viral pharyngitis (most likely in typical URI pattern)",
      "Streptococcal pharyngitis",
      "Peritonsillar abscess (if red flags)"
    ]
  },

  fever: {
    nameEn: "fever",
    history: [
      { id: "duration", labelEn: "Duration", labelZh: "發燒多久？", type: "text" },
      { id: "max_temp", labelEn: "Maximal temperature", labelZh: "最高體溫？", type: "text" },
      { id: "resp", labelEn: "Respiratory symptoms", labelZh: "呼吸道症狀（咳/痰/喉嚨痛）", type: "text" },
      { id: "gi", labelEn: "GI symptoms", labelZh: "腸胃症狀（噁心/腹瀉）", type: "text" },
      { id: "urinary", labelEn: "Urinary symptoms", labelZh: "泌尿症狀（頻尿/解尿痛）", type: "text" },
      { id: "travel", labelEn: "Travel / TOCC", labelZh: "旅遊史/TOCC", type: "text" }
    ],
    ddx: [
      "Viral infection",
      "Bacterial infection",
      "UTI (if urinary symptoms)",
      "Pneumonia (if cough/SOB)"
    ]
  },

  abd_pain: {
    nameEn: "abdominal pain",
    history: [
      { id: "duration", labelEn: "Duration", labelZh: "腹痛多久？", type: "text" },
      { id: "location", labelEn: "Pain location", labelZh: "部位？", type: "text" },
      { id: "character", labelEn: "Pain character", labelZh: "性質？（悶痛/絞痛/刺痛）", type: "text" },
      { id: "gi", labelEn: "GI symptoms", labelZh: "噁心/嘔吐/腹瀉？", type: "text" },
      { id: "bleed", labelEn: "GI bleeding", labelZh: "黑便/血便？", type: "text" },
      { id: "urinary", labelEn: "Urinary symptoms", labelZh: "泌尿症狀？", type: "text" },
      { id: "gyne", labelEn: "Gynecologic history", labelZh: "月經/懷孕可能？", type: "text" }
    ],
    ddx: [
      "Gastroenteritis",
      "Peptic ulcer disease",
      "Appendicitis",
      "Cholecystitis",
      "Renal colic",
      "Gynecologic causes (if female)"
    ]
  }
};

// ========================== UI UPDATE ==========================
const ccSelect        = document.getElementById("ccSelect");
const historyArea     = document.getElementById("historyArea");
const output          = document.getElementById("output");
const generateBtn     = document.getElementById("generateBtn");
const openEvidenceBtn = document.getElementById("openEvidenceBtn");

ccSelect.addEventListener("change", () => {
  const key = ccSelect.value;
  historyArea.innerHTML = "";

  if (!key) {
    historyArea.textContent = "Select a chief complaint.";
    return;
  }

  const tpl = templates[key];

  tpl.history.forEach(q => {
    const label = document.createElement("label");
    label.textContent = q.labelZh;
    const input = document.createElement("input");
    input.type = q.type;
    input.id = "q_" + q.id;
    input.style.width = "80%";
    historyArea.appendChild(label);
    historyArea.appendChild(input);
  });
});

// ========================== GENERATE SOAP + Dx summary ==========================
generateBtn.addEventListener("click", () => {
  const key = ccSelect.value;
  if (!key) { alert("Select a chief complaint first"); return; }

  const tpl      = templates[key];
  const age      = document.getElementById("age").value;
  const sex      = document.getElementById("sex").value; // M / F / ""
  const ph       = (document.getElementById("ph").value || "").trim();
  const allergy  = (document.getElementById("allergy").value || "").trim();
  const med      = (document.getElementById("med").value || "").trim();
  const fh       = (document.getElementById("fh").value || "").trim();

  // 收集問診答案
  const answers = {};
  tpl.history.forEach(q => {
    answers[q.id] = (document.getElementById("q_" + q.id)?.value || "").trim();
  });

  // ---------- S ----------
  let S = "S:\n";

  const duration = answers["duration"] || "";
  S += `CC: ${tpl.nameEn.charAt(0).toUpperCase() + tpl.nameEn.slice(1)}${duration ? " for " + duration : ""}\n`;

  S += "PI:\n";
  if (age || sex) S += `${age || ""}${sex || ""}\n`;

  tpl.history.forEach(q => {
    if (q.id === "duration") return;
    const val = answers[q.id];
    if (val) {
      S += `- ${q.labelEn}: ${val}.\n`;
    }
  });

  S += `PH: ${ph || "denied"}\n`;
  S += `Allergy: ${allergy || "NKA"}\n`;
  S += `Med: ${med || "denied"}\n`;
  S += `FH: ${fh || "no contributory"}\n\n`;

  // ---------- O ----------
  let O = "O:\nVS: T / BP\nHEENT:\nChest:\n\n";

  // ---------- DDx ----------
  let D = "DDx:\n";
  tpl.ddx.forEach(item => D += "- " + item + "\n");
  D += "\n";

  // ---------- Dx summary（類 OE 風格，簡單 rule-based） ----------
  let summary = "Dx summary:\n";

  if (key === "sore_throat") {
    const feverStr = answers["fever"] || "";
    const coughStr = answers["cough"] || "";
    const rhinStr  = answers["rhinorrhea"] || "";
    const hasFever = /[0-9]/.test(feverStr) || /yes/i.test(feverStr);
    const hasCough = /[a-z]/i.test(coughStr) && !/no/i.test(coughStr);
    const hasRhin  = /[a-z]/i.test(rhinStr) && !/no/i.test(rhinStr);

    if (hasFever && !hasCough) {
      summary += "1. Streptococcal or other bacterial pharyngitis: sore throat with fever and minimal cough raises the possibility of bacterial infection.\n";
      summary += "2. Viral pharyngitis: still possible, especially if rhinorrhea or other URI symptoms are present.\n";
    } else {
      summary += "1. Viral pharyngitis: sore throat associated with cough and/or rhinorrhea is most compatible with viral upper respiratory infection.\n";
      summary += "2. Streptococcal pharyngitis: consider if tonsillar exudate, tender cervical lymphadenopathy, or high fever.\n";
    }
    summary += "3. Peritonsillar abscess: less likely currently, but reconsider if patient develops severe unilateral throat pain, trismus, muffled voice, or drooling.\n";
  }

  if (key === "fever") {
    const respStr   = answers["resp"] || "";
    const giStr     = answers["gi"] || "";
    const urinaryStr= answers["urinary"] || "";

    const hasResp   = /[a-z]/i.test(respStr) && !/no/i.test(respStr);
    const hasGI     = /[a-z]/i.test(giStr) && !/no/i.test(giStr);
    const hasUri    = /[a-z]/i.test(urinaryStr) && !/no/i.test(urinaryStr);

    if (hasResp) {
      summary += "1. Viral upper respiratory infection: fever with respiratory symptoms (e.g., cough, sore throat, rhinorrhea) is most compatible with viral URI.\n";
      summary += "2. Pneumonia: consider if productive cough, dyspnea, or abnormal lung auscultation.\n";
    } else if (hasGI) {
      summary += "1. Acute gastroenteritis: fever with GI symptoms (nausea, vomiting, diarrhea) suggests GI infection.\n";
    } else if (hasUri) {
      summary += "1. Urinary tract infection: fever with urinary symptoms suggests UTI or pyelonephritis.\n";
    } else {
      summary += "1. Viral infection: current presentation is non-specific; viral etiology is common.\n";
    }
    summary += "2. Bacterial infection at other sites should be considered based on further examination and laboratory results.\n";
  }

  if (key === "abd_pain") {
    const loc  = answers["location"] || "";
    const gi   = answers["gi"] || "";
    const bleed= answers["bleed"] || "";
    const hasBleed = /black stool|melena|blood|hematochezia/i.test(bleed);

    summary += "1. Gastroenteritis: abdominal pain with GI symptoms such as nausea, vomiting or diarrhea is compatible with acute gastroenteritis.\n";
    summary += "2. Peptic ulcer disease or gastritis: consider if epigastric pain related to meals or chronic dyspepsia.\n";
    summary += "3. Appendicitis or localized surgical abdomen: reconsider if pain migrates, localizes (e.g., RLQ), or shows peritoneal signs on exam.\n";
    if (hasBleed) {
      summary += "4. GI bleeding: presence of black or bloody stool raises concern for GI bleeding; further evaluation is indicated.\n";
    }
    summary += "5. Biliary or renal causes (e.g., cholecystitis, renal colic) and gynecologic causes (in female patients) should be ruled out based on location of pain and associated symptoms.\n";
  }

  const fullText = S + O + D + summary;
  output.value = fullText;
});

// ========================== OpenEvidence link（Plan A） ==========================
openEvidenceBtn.addEventListener("click", () => {
  const key = ccSelect.value;
  if (!key) { alert("Select a chief complaint first"); return; }

  const tpl = templates[key];
  const answers = {};
  tpl.history.forEach(q => {
    answers[q.id] = (document.getElementById("q_" + q.id)?.value || "").trim();
  });

  const parts = [];
  parts.push(tpl.nameEn);
  if (answers["duration"]) parts.push(answers["duration"] + " duration");
  Object.keys(answers).forEach(id => {
    if (id === "duration") return;
    if (answers[id]) parts.push(answers[id]);
  });

  const query = encodeURIComponent(parts.join(" "));
  const url   = "https://www.openevidence.com/search?q=" + query;
  window.open(url, "_blank");
});
</script>

</body>
</html>
