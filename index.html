<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Clinic SOAP Generator</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 20px;
      line-height: 1.5;
      background: #000;
      color: #f5f5f5;
    }
    label { display: block; margin-top: 8px; }
    .section {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #111;
      border: 1px solid #333;
    }
    textarea {
      width: 100%;
      height: 260px;
      background: #111;
      color: #f5f5f5;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px;
    }
    select, input {
      padding: 4px;
      margin-top: 4px;
      background: #111;
      color: #f5f5f5;
      border: 1px solid #555;
      border-radius: 4px;
    }
    button {
      padding: 8px 14px;
      margin-top: 10px;
      margin-right: 6px;
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #888;
      background: #222;
      color: #f5f5f5;
    }
    button:hover {
      background: #333;
    }
    h2 { margin-bottom: 16px; }
  </style>
</head>

<body>

<h2>Clinic SOAP Generator</h2>

<!-- Patient Info -->
<div class="section">
  <strong>Patient Info</strong><br>
  Age: <input id="age" type="number" min="0" max="120" style="width: 60px;">
  Sex:
  <select id="sex">
    <option value="">--</option>
    <option value="M">Male</option>
    <option value="F">Female</option>
  </select>
</div>

<!-- Past history group -->
<div class="section">
  <strong>Past / Allergy / Med / Family</strong>
  <label>PH:</label>
  <input id="ph" type="text" placeholder="預設 denied">
  <label>Allergy:</label>
  <input id="allergy" type="text" placeholder="預設 NKA">
  <label>Med:</label>
  <input id="med" type="text" placeholder="預設 denied">
  <label>FH:</label>
  <input id="fh" type="text" placeholder="預設 no contributory">
</div>

<!-- Chief complaint -->
<div class="section">
  <label>Chief complaint:</label>
  <select id="ccSelect">
    <option value="">Select</option>
    <option value="sore_throat">Sore throat</option>
    <option value="fever">Fever / URI</option>
    <option value="abd_pain">Abdominal pain</option>
  </select>
</div>

<!-- History dynamic area -->
<div class="section">
  <strong>History questions:</strong>
  <div id="historyArea">Select a chief complaint to begin.</div>
</div>

<!-- Buttons -->
<div class="section">
  <button id="generateBtn">Generate SOAP + Dx summary</button>
  <button id="openEvidenceBtn">Open in OpenEvidence</button>
</div>

<!-- Output -->
<div class="section">
  <strong>Output (copy into HIS):</strong>
  <textarea id="output"></textarea>
</div>

<script>
// =========================================================
// TEMPLATES FOR CC
// =========================================================
const templates = {
  sore_throat: {
    nameEn: "sore throat",
    history: [
      { id:"duration", labelEn:"Duration", labelZh:"症狀多久？（天）" },
      { id:"fever", labelEn:"Fever history / maximal temperature", labelZh:"發燒？最高幾度？" },
      { id:"cough", labelEn:"Cough", labelZh:"咳嗽？" },
      { id:"rhinorrhea", labelEn:"Rhinorrhea / nasal congestion", labelZh:"流鼻水？鼻塞？" },
      { id:"odynophagia", labelEn:"Odynophagia", labelZh:"吞嚥痛？" },
      { id:"tocc", labelEn:"TOCC", labelZh:"接觸史 / 感染接觸者？" }
    ],
    ddx: [
      "Viral pharyngitis",
      "Streptococcal pharyngitis",
      "Peritonsillar abscess"
    ]
  },

  fever: {
    nameEn: "fever",
    history: [
      { id:"duration", labelEn:"Duration", labelZh:"發燒多久？" },
      { id:"max_temp", labelEn:"Maximal temperature", labelZh:"最高體溫？" },
      { id:"resp", labelEn:"Respiratory symptoms", labelZh:"呼吸道症狀？" },
      { id:"gi", labelEn:"GI symptoms", labelZh:"腸胃症狀？" },
      { id:"urinary", labelEn:"Urinary symptoms", labelZh:"泌尿症狀？" },
      { id:"travel", labelEn:"Travel / TOCC", labelZh:"旅遊史/TOCC？" }
    ],
    ddx: [
      "Viral infection",
      "Bacterial infection",
      "UTI",
      "Pneumonia"
    ]
  },

  abd_pain: {
    nameEn: "abdominal pain",
    history: [
      { id:"duration", labelEn:"Duration", labelZh:"腹痛多久？" },
      { id:"location", labelEn:"Pain location", labelZh:"部位？" },
      { id:"character", labelEn:"Pain character", labelZh:"性質？" },
      { id:"gi", labelEn:"GI symptoms", labelZh:"噁心/嘔吐/腹瀉？" },
      { id:"bleed", labelEn:"GI bleeding", labelZh:"黑便/血便？" },
      { id:"urinary", labelEn:"Urinary symptoms", labelZh:"泌尿症狀？" },
      { id:"gyne", labelEn:"Gynecologic", labelZh:"月經/懷孕？（女性）" }
    ],
    ddx: [
      "Gastroenteritis",
      "Peptic ulcer disease",
      "Appendicitis",
      "Cholecystitis",
      "Renal colic"
    ]
  }
};

// =========================================================
// BUILD HISTORY QUESTIONS
// =========================================================
const ccSelect = document.getElementById("ccSelect");
const historyArea = document.getElementById("historyArea");
const output = document.getElementById("output");

ccSelect.addEventListener("change", () => {
  const key = ccSelect.value;
  historyArea.innerHTML = "";

  if (!key) {
    historyArea.textContent = "Select a chief complaint.";
    return;
  }

  const tpl = templates[key];
  tpl.history.forEach(q => {
    const label = document.createElement("label");
    label.textContent = q.labelZh;
    const input = document.createElement("input");
    input.type = "text";
    input.id = "q_" + q.id;
    input.style.width = "80%";
    historyArea.appendChild(label);
    historyArea.appendChild(input);
  });
});

// =========================================================
// GENERATE SOAP + DX SUMMARY
// =========================================================
document.getElementById("generateBtn").addEventListener("click", () => {
  const key = ccSelect.value;
  if (!key) { alert("Select CC first!"); return; }

  const tpl = templates[key];

  // Collect answers
  const answers = {};
  tpl.history.forEach(q => {
    answers[q.id] = (document.getElementById("q_" + q.id)?.value || "").trim();
  });

  // Basic info
  const age = document.getElementById("age").value;
  const sex = document.getElementById("sex").value;

  const ph = (document.getElementById("ph").value.trim()) || "denied";
  const allergy = (document.getElementById("allergy").value.trim()) || "NKA";
  const med = (document.getElementById("med").value.trim()) || "denied";
  const fh = (document.getElementById("fh").value.trim()) || "no contributory";

  // ------------------- S -------------------
  let S = "S:\n";
  S += `CC: ${tpl.nameEn}${answers["duration"] ? " for " + answers["duration"] : ""}\n`;
  S += `PI:\n${age || ""}${sex || ""}\n`;

  tpl.history.forEach(q => {
    if (q.id === "duration") return;
    if (answers[q.id]) S += `- ${q.labelEn}: ${answers[q.id]}.\n`;
  });

  S += `PH: ${ph}\nAllergy: ${allergy}\nMed: ${med}\nFH: ${fh}\n\n`;

  // ------------------- O -------------------
  let O = "O:\nVS: T / BP\nHEENT:\nChest:\n\n";

  // ------------------- DDx -------------------
  let D = "DDx:\n";
  tpl.ddx.forEach(d => (D += "- " + d + "\n"));
  D += "\n";

  // ------------------- Dx Summary -------------------
  let summary = "Dx summary:\n";

  if (key === "sore_throat") {
    const fever = answers["fever"] || "";
    const cough = answers["cough"] || "";
    if (/38|39|40/.test(fever) && /no/i.test(cough)) {
      summary += "1. Streptococcal pharyngitis possible (fever without cough).\n";
    } else {
      summary += "1. Viral pharyngitis most likely.\n";
    }
    summary += "2. Observe red flags: trismus, muffled voice, drooling.\n";
  }

  if (key === "abd_pain") {
    summary += "Abdominal pain ddx depends on location, GI/urinary/gyne symptoms.\n";
    if (/black|blood|melena/i.test(answers["bleed"] || "")) {
      summary += "⚠ GI bleeding suspected.\n";
    }
  }

  if (key === "fever") {
    summary += "Fever ddx includes viral infection, URI, UTI, pneumonia.\n";
  }

  output.value = S + O + D + summary;
});

// =========================================================
// OPEN IN OPENEVIDENCE (SAFE VERSION)
// =========================================================
document.getElementById("openEvidenceBtn").addEventListener("click", () => {
  const key = ccSelect.value;
  if (!key) { alert("Select CC first"); return; }

  const tpl = templates[key];

  const answers = {};
  tpl.history.forEach(q => {
    answers[q.id] = (document.getElementById("q_" + q.id)?.value || "").trim();
  });

  const queryParts = [];
  queryParts.push(tpl.nameEn);
  if (answers["duration"]) queryParts.push("for " + answers["duration"]);
  Object.values(answers).forEach(v => {
    if (v) queryParts.push(v);
  });

  const textToCopy = queryParts.join(" | ");

  // copy to clipboard
  navigator.clipboard?.writeText(textToCopy);

  alert("已複製問診摘要，到 OpenEvidence 後直接貼上即可。");

  window.open("https://www.openevidence.com/", "_blank");
});
</script>

</body>
</html>
