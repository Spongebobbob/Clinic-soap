<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Clinic SOAP Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #f5f5f5;
      line-height: 1.5;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 12px;
    }
    .section {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #1b1b1b;
      border: 1px solid #333;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 0.95rem;
    }
    input[type="number"],
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 6px 8px;
      font-size: 0.95rem;
      border-radius: 6px;
      border: 1px solid #444;
      background: #111;
      color: #f5f5f5;
      box-sizing: border-box;
    }
    textarea {
      min-height: 180px;
      resize: vertical;
      white-space: pre-wrap;
    }
    button {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #000;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 6px;
    }
    button.secondary {
      background: #3b82f6;
      color: #fff;
    }
    button.outline {
      background: transparent;
      border: 1px solid #555;
      color: #f5f5f5;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .row > .col {
      flex: 1 1 120px;
    }
    .hint {
      font-size: 0.8rem;
      color: #aaa;
      margin-top: 4px;
    }
    pre {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <h1>Clinic SOAP Generator</h1>

  <!-- Patient basic info -->
  <div class="section">
    <div class="row">
      <div class="col">
        <label for="age">Age:</label>
        <input id="age" type="number" min="0" value="30" />
      </div>
      <div class="col">
        <label for="sex">Sex:</label>
        <select id="sex">
          <option value="male">Male</option>
          <option value="female">Female</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Chief complaint -->
  <div class="section">
    <label for="cc">Chief complaint (CC):</label>
    <select id="cc">
      <option value="">-- select --</option>
      <option value="sore_throat">Sore throat</option>
      <option value="custom">Other (custom)</option>
    </select>
    <div id="ccCustomWrap" style="margin-top:8px; display:none;">
      <label for="ccCustomText">Custom CC (English):</label>
      <input id="ccCustomText" type="text" placeholder="e.g. Chest pain for 2 hours" />
    </div>
  </div>

  <!-- History questions for sore throat -->
  <div class="section" id="historySoreThroat" style="display:none;">
    <strong>History questions – sore throat</strong>

    <label for="duration">症狀多久？（天）</label>
    <input id="duration" type="number" min="0" value="3" />

    <label for="feverMax">發燒？最高幾度？</label>
    <input id="feverMax" type="text" placeholder="e.g. 38.5" />

    <label for="cough">咳嗽？</label>
    <select id="cough">
      <option value="">-- select --</option>
      <option value="no">No</option>
      <option value="dry">Dry cough</option>
      <option value="productive">Productive</option>
    </select>

    <label for="rhino">流鼻水 / 鼻塞？</label>
    <select id="rhino">
      <option value="">-- select --</option>
      <option value="none">No</option>
      <option value="mild">Mild rhinorrhea / nasal congestion</option>
      <option value="severe">Severe rhinorrhea / congestion</option>
    </select>

    <label for="odyno">吞嚥痛（odynophagia）？</label>
    <select id="odyno">
      <option value="">-- select --</option>
      <option value="yes">Yes</option>
      <option value="no">No</option>
    </select>

    <label for="tocc">接觸史 / 感染接觸者？</label>
    <input id="tocc" type="text" placeholder="e.g. coworker / family / denied" />
  </div>

  <!-- Custom PI for other CC -->
  <div class="section" id="historyCustom" style="display:none;">
    <strong>History – custom</strong>
    <label for="piCustom">
      PI (English free text) – you can type directly if not sore throat.
    </label>
    <textarea
      id="piCustom"
      placeholder="e.g. 45-year-old male with chest pain for 2 hours, retrosternal, non-radiating, not related to exertion..."
    ></textarea>
  </div>

  <!-- PH / Allergy / Med / FH -->
  <div class="section">
    <strong>Background</strong>
    <label for="ph">Past history (PH) – optional</label>
    <input id="ph" type="text" placeholder="empty = denied" />

    <label for="allergy">Allergy – optional</label>
    <input id="allergy" type="text" placeholder="empty = NKA" />

    <label for="med">Regular medication – optional</label>
    <input id="med" type="text" placeholder="empty = denied" />

    <label for="fh">Family history (FH) – optional</label>
    <input id="fh" type="text" placeholder="empty = no contributory" />
    <div class="hint">
      若留白，生成時會自動填入：<br />
      PH: denied / Allergy: NKA / Med: denied / FH: no contributory
    </div>
  </div>

  <!-- Buttons -->
  <div class="section">
    <button id="generateBtn">Generate SOAP</button>
    <button id="openEvidenceBtn" class="secondary">Open in OpenEvidence</button>
    <button id="askAiBtn" class="outline">Ask AI (silent)</button>
  </div>

  <!-- SOAP output -->
  <div class="section">
    <label for="output">Output (copy into HIS):</label>
    <textarea id="output"></textarea>
  </div>

  <!-- AI result -->
  <div class="section">
    <strong>AI suggestion (hidden consultant):</strong>
    <div id="aiStatus" class="hint"></div>
    <pre id="aiResult"></pre>
  </div>

  <script>
    const ageInput = document.getElementById("age");
    const sexSelect = document.getElementById("sex");
    const ccSelect = document.getElementById("cc");
    const ccCustomWrap = document.getElementById("ccCustomWrap");
    const ccCustomText = document.getElementById("ccCustomText");

    const historySoreThroat = document.getElementById("historySoreThroat");
    const historyCustom = document.getElementById("historyCustom");

    const durationInput = document.getElementById("duration");
    const feverMaxInput = document.getElementById("feverMax");
    const coughSelect = document.getElementById("cough");
    const rhinoSelect = document.getElementById("rhino");
    const odynoSelect = document.getElementById("odyno");
    const toccInput = document.getElementById("tocc");

    const phInput = document.getElementById("ph");
    const allergyInput = document.getElementById("allergy");
    const medInput = document.getElementById("med");
    const fhInput = document.getElementById("fh");

    const output = document.getElementById("output");

    const generateBtn = document.getElementById("generateBtn");
    const openEvidenceBtn = document.getElementById("openEvidenceBtn");
    const askAiBtn = document.getElementById("askAiBtn");
    const aiStatus = document.getElementById("aiStatus");
    const aiResult = document.getElementById("aiResult");

    // 切換 CC 顯示的問診區塊
    ccSelect.addEventListener("change", () => {
      const v = ccSelect.value;
      historySoreThroat.style.display = v === "sore_throat" ? "block" : "none";
      historyCustom.style.display = v === "custom" ? "block" : "none";
      ccCustomWrap.style.display = v === "custom" ? "block" : "none";
    });

    function sexToShort(sex) {
      return sex === "female" ? "F" : "M";
    }

    function buildPiSoreThroat() {
      const age = ageInput.value || "";
      const sex = sexSelect.value || "male";
      const sexWord = sex === "female" ? "female" : "male";

      const dur = durationInput.value || "";
      const fever = feverMaxInput.value.trim();
      const cough = coughSelect.value;
      const rh = rhinoSelect.value;
      const od = odynoSelect.value;
      const tocc = toccInput.value.trim();

      let sentence = `${age}-year-old ${sexWord} with sore throat`;
      if (dur) sentence += ` for ${dur} days`;

      const fragments = [];

      if (fever) fragments.push(`fever up to ${fever}°C`);
      if (rh === "mild") fragments.push("mild rhinorrhea");
      else if (rh === "severe") fragments.push("severe rhinorrhea / nasal congestion");

      if (od === "yes") fragments.push("odynophagia");
      if (cough === "no") fragments.push("no cough");
      else if (cough === "dry") fragments.push("dry cough");
      else if (cough === "productive") fragments.push("productive cough");

      if (tocc) fragments.push(`TOCC: ${tocc}`);

      if (fragments.length > 0) {
        sentence += ", " + fragments.join(", ") + ".";
      } else {
        sentence += ".";
      }
      return sentence;
    }

    // 產生 SOAP
    generateBtn.addEventListener("click", () => {
      const ccType = ccSelect.value;
      if (!ccType) {
        alert("請先選擇 CC");
        return;
      }

      const age = ageInput.value || "";
      const sex = sexSelect.value || "male";
      const sexShort = sexToShort(sex);

      let ccLine = "";
      let piText = "";

      if (ccType === "sore_throat") {
        const dur = durationInput.value || "";
        ccLine = `CC: Sore throat${dur ? " for " + dur + " days" : ""}`;
        piText = buildPiSoreThroat();
      } else if (ccType === "custom") {
        const customCC = ccCustomText.value.trim();
        ccLine = customCC ? `CC: ${customCC}` : "CC: ";
        const customPI = document.getElementById("piCustom").value.trim();
        piText = customPI || "(no PI)";
      }

      const ph = (phInput.value || "").trim() || "denied";
      const al = (allergyInput.value || "").trim() || "NKA";
      const med = (medInput.value || "").trim() || "denied";
      const fh = (fhInput.value || "").trim() || "no contributory";

      let s = "S:\n";
      s += ccLine + "\n";
      s += "PI:\n";
      if (ccType === "custom" && !piText.startsWith(age)) {
        // 如果是 custom 而且開頭不是年齡，就幫忙補上 "xx-year-old M/F, ..."
        const sexWord = sex === "female" ? "female" : "male";
        s += `${age}-year-old ${sexWord}, ${piText}\n`;
      } else {
        s += piText + "\n";
      }
      s += `PH: ${ph}\nAllergy: ${al}\nMed: ${med}\nFH: ${fh}\n\n`;
      s += "O:\nVS: T / BP\nHEENT:\nChest:\n";

      output.value = s;
    });

    // OpenEvidence：用簡單 query 丟過去
    openEvidenceBtn.addEventListener("click", () => {
      const ccType = ccSelect.value;
      if (!ccType) {
        alert("請先選擇 CC 並產生 SOAP");
        return;
      }
      const dur = durationInput.value || "";
      const fever = feverMaxInput.value.trim();
      const cough = coughSelect.value || "N/A";
      const rh = rhinoSelect.value || "N/A";
      const od = odynoSelect.value || "N/A";
      const tocc = toccInput.value.trim() || "Denied";

      let q = "";
      if (ccType === "sore_throat") {
        q =
          `sore throat | for ${dur || "?"} days | ` +
          `${fever || "no fever"} | ${cough} | ${rh} | ${od} | ${tocc}`;
      } else {
        q = output.value.slice(0, 300); // 其他就直接截 SOAP 前 300 字
      }

      const url = "https://openevidence.com/?q=" + encodeURIComponent(q);
      window.open(url, "_blank");
    });

    // ========================== Ask AI via backend ==========================
    const AI_API_URL =
      "https://clinic-soap-3de15p6bz-brians-projects-7190b7c2.vercel.app/api/clinic-ai";

    askAiBtn.addEventListener("click", async () => {
      const soap = output.value.trim();
      if (!soap) {
        alert("請先按『Generate SOAP』產生病例，再請 AI 給建議。");
        return;
      }

      aiStatus.textContent = "AI thinking...";
      aiResult.textContent = "";

      try {
        const resp = await fetch(AI_API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ soap }),
        });

        if (!resp.ok) {
          aiStatus.textContent = "AI error (server side).";
          try {
            const errData = await resp.json();
            aiResult.textContent = JSON.stringify(errData, null, 2);
          } catch (e) {
            aiResult.textContent = "";
          }
          return;
        }

        const data = await resp.json();
        if (data.error) {
          aiStatus.textContent = "AI error: " + (data.error || "");
          aiResult.textContent = data.detail || "";
          return;
        }

        aiStatus.textContent = "AI suggestion:";
        aiResult.textContent = data.answer || "(no content)";
      } catch (e) {
        aiStatus.textContent = "Network or server error.";
        console.error(e);
      }
    });
  </script>
</body>
</html>
